<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<meta name="description" content="LightningJ-Paywall is a project to make it simple to provide Lightning Micropayment Paywall to your spring or spring boot applications.">
<meta name="keywords" content="paywall,spring,spring boot,bitcoin,lightning,java,lnd,lightningj">
<title>LightningJ - Paywall.</title>
<style>
/*! normalize.css v2.1.2 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address `[hidden]` styling not present in IE 8/9. Hide the `template` element in IE, Safari, and Firefox < 22. */
[hidden], template { display: none; }

script { display: none !important; }

/* ========================================================================== Base ========================================================================== */
/** 1. Set default font family to sans-serif. 2. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { font-family: sans-serif; /* 1 */ -ms-text-size-adjust: 100%; /* 2 */ -webkit-text-size-adjust: 100%; /* 2 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Remove the gray background color from active links in IE 10. */
a { background: transparent; }

/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

meta.foundation-mq-small { font-family: "only screen and (min-width: 768px)"; width: 768px; }

meta.foundation-mq-medium { font-family: "only screen and (min-width:1280px)"; width: 1280px; }

meta.foundation-mq-large { font-family: "only screen and (min-width:1440px)"; width: 1440px; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 100%; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

object, svg { display: inline-block; vertical-align: middle; }

.center { margin-left: auto; margin-right: auto; }

.spread { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }

.subheader, .admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { line-height: 1.4; color: #003b6b; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #00579e; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #333333; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: Arial, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Arial, sans-serif; font-weight: normal; font-style: normal; color: #7b2d00; text-rendering: optimizeLegibility; margin-top: 0.5em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #ff6b15; line-height: 0; }

h1 { font-size: 2.125em; }

h2 { font-size: 1.6875em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }

h4 { font-size: 1.125em; }

h5 { font-size: 1.125em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: bold; color: #003426; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 0.75em; list-style-position: outside; font-family: Arial, sans-serif; }

ul, ol { margin-left: 1.5em; }
ul.no-bullet, ol.no-bullet { margin-left: 1.5em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.25em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.25em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.3em; font-weight: bold; }
dl dd { margin-bottom: 0.75em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: black; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 0.75em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: 0.8125em; color: #e15200; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #e15200; }

blockquote, blockquote p { line-height: 1.6; color: #333333; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
/* Tables */
table { background: white; margin-bottom: 1.25em; border: solid 1px #d8d8ce; }
table thead, table tfoot { background: -webkit-linear-gradient(top, #add386, #90b66a); font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: white; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #6d6e71; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #edf2f2; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

body { -moz-osx-font-smoothing: grayscale; -webkit-font-smoothing: antialiased; tab-size: 4; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: inherit; font-style: normal !important; letter-spacing: 0; padding: 3px 2px 1px 2px; background-color: #eeeeee; border: 1px solid #dddddd; -webkit-border-radius: 0; border-radius: 0; line-height: inherit; word-wrap: break-word; }
*:not(pre) > code.nobreak { word-wrap: normal; }
*:not(pre) > code.nowrap { white-space: nowrap; }

pre, pre > code { line-height: 1.6; color: black; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

em em { font-style: normal; }

strong strong { font-weight: normal; }

.keyseq { color: #333333; }

kbd { font-family: Consolas, "Liberation Mono", Courier, monospace; display: inline-block; color: black; font-size: 0.65em; line-height: 1.45; background-color: #f7f7f7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 0.1em white inset; margin: 0 0.15em; padding: 0.2em 0.5em; vertical-align: middle; position: relative; top: -0.1em; white-space: nowrap; }

.keyseq kbd:first-child { margin-left: 0; }

.keyseq kbd:last-child { margin-right: 0; }

.menuseq, .menuref { color: #000; }

.menuseq b:not(.caret), .menuref { font-weight: inherit; }

.menuseq { word-spacing: -0.02em; }
.menuseq b.caret { font-size: 1.25em; line-height: 0.8; }
.menuseq i.caret { font-weight: bold; text-align: center; width: 0.45em; }

b.button:before, b.button:after { position: relative; top: -1px; font-weight: normal; }

b.button:before { content: "["; padding: 0 3px 0 2px; }

b.button:after { content: "]"; padding: 0 2px 0 3px; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 1.5em; padding-right: 1.5em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#content { margin-top: 1.25em; }

#content:before { content: none; }

#header > h1:first-child { color: #7b2d00; margin-top: 2.25rem; margin-bottom: 0; }
#header > h1:first-child + #toc { margin-top: 8px; border-top: 1px solid #dddddd; }
#header > h1:only-child, body.toc2 #header > h1:nth-last-child(2) { border-bottom: 1px solid #dddddd; padding-bottom: 8px; }
#header .details { border-bottom: 1px solid #dddddd; line-height: 1.45; padding-top: 0.25em; padding-bottom: 0.25em; padding-left: 0.25em; color: #e15200; display: -ms-flexbox; display: -webkit-flex; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; }
#header .details span:first-child { margin-left: -0.125em; }
#header .details span.email a { color: #333333; }
#header .details br { display: none; }
#header .details br + span:before { content: "\00a0\2013\00a0"; }
#header .details br + span.author:before { content: "\00a0\22c5\00a0"; color: #333333; }
#header .details br + span#revremark:before { content: "\00a0|\00a0"; }
#header #revnumber { text-transform: capitalize; }
#header #revnumber:after { content: "\00a0"; }

#content > h1:first-child:not([class]) { color: #7b2d00; border-bottom: 1px solid #dddddd; padding-bottom: 8px; margin-top: 0; padding-top: 1rem; margin-bottom: 1.25rem; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 0.5em; }
#toc > ul { margin-left: 0.125em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin: 0.5em 0; }
#toc ul { font-family: Arial, sans-serif; list-style-type: none; }
#toc li { line-height: 1.3334; margin-top: 0.3334em; }
#toc a { text-decoration: none; }
#toc a:active { text-decoration: underline; }

#toctitle { color: #003b6b; font-size: 1.2em; }

@media only screen and (min-width: 768px) { #toctitle { font-size: 1.375em; }
  body.toc2 { padding-left: 15em; padding-right: 0; }
  #toc.toc2 { margin-top: 0 !important; background-color: white; position: fixed; width: 15em; left: 0; top: 0; border-right: 1px solid #dddddd; border-top-width: 0 !important; border-bottom-width: 0 !important; z-index: 1000; padding: 1.25em 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; margin-bottom: 0.8rem; font-size: 1.2em; }
  #toc.toc2 > ul { font-size: 0.9em; margin-bottom: 0; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 15em; }
  body.toc2.toc-right #toc.toc2 { border-right-width: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; padding-right: 0; }
  #toc.toc2 { width: 20em; }
  #toc.toc2 #toctitle { font-size: 1.375em; }
  #toc.toc2 > ul { font-size: 0.95em; }
  #toc.toc2 ul ul { padding-left: 1.25em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }

#footer { max-width: 100%; background-color: none; padding: 1.25em; }

#footer-text { color: black; line-height: 1.44; }

#content { margin-bottom: 0.625em; }

.sect1 { padding-bottom: 0.625em; }

@media only screen and (min-width: 768px) { #content { margin-bottom: 1.25em; }
  .sect1 { padding-bottom: 1.25em; } }
.sect1:last-child { padding-bottom: 0; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; z-index: 1001; width: 1.5ex; margin-left: -1.5ex; display: block; text-decoration: none !important; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: "\00A7"; font-size: 0.85em; display: block; padding-top: 0.1em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #7b2d00; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #622400; }

.audioblock, .imageblock, .literalblock, .listingblock, .stemblock, .videoblock { margin-bottom: 1.25em; }

.admonitionblock td.content > .title, .audioblock > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .stemblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, table.tableblock > .title, .verseblock > .title, .videoblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-rendering: optimizeLegibility; text-align: left; }

table.tableblock > caption.title { white-space: nowrap; overflow: visible; max-width: 0; }

.paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { color: #7b2d00; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border-collapse: separate; border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; font-family: Arial, sans-serif; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #e15200; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 0; border-radius: 0; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock > .content > .title { color: #003b6b; margin-top: 0; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock pre, .listingblock pre:not(.highlight), .listingblock pre[class="highlight"], .listingblock pre[class^="highlight "], .listingblock pre.CodeRay, .listingblock pre.prettyprint { background: #eeeeee; }
.sidebarblock .literalblock pre, .sidebarblock .listingblock pre:not(.highlight), .sidebarblock .listingblock pre[class="highlight"], .sidebarblock .listingblock pre[class^="highlight "], .sidebarblock .listingblock pre.CodeRay, .sidebarblock .listingblock pre.prettyprint { background: #f2f1f1; }

.literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { border: 1px dashed #666666; -webkit-border-radius: 0; border-radius: 0; word-wrap: break-word; padding: 1.25em 1.5625em 1.125em 1.5625em; font-size: 0.8125em; }
.literalblock pre.nowrap, .literalblock pre[class].nowrap, .listingblock pre.nowrap, .listingblock pre[class].nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
@media only screen and (min-width: 768px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 0.90625em; } }
@media only screen and (min-width: 1280px) { .literalblock pre, .literalblock pre[class], .listingblock pre, .listingblock pre[class] { font-size: 1em; } }

.literalblock.output pre { color: #eeeeee; background-color: black; }

.listingblock pre.highlightjs { padding: 0; }
.listingblock pre.highlightjs > code { padding: 1.25em 1.5625em 1.125em 1.5625em; -webkit-border-radius: 0; border-radius: 0; }

.listingblock > .content { position: relative; }

.listingblock code[data-lang]:before { display: none; content: attr(data-lang); position: absolute; font-size: 0.75em; top: 0.425rem; right: 0.5rem; line-height: 1; text-transform: uppercase; color: #999; }

.listingblock:hover code[data-lang]:before { display: block; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: "$"; }

table.pyhltable { border-collapse: separate; border: 0; margin-bottom: 0; background: none; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; line-height: 1.6; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

pre.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

pre.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background: none !important; padding-right: 0 !important; }

.quoteblock { margin: 0 1em 0.75em 1.5em; display: table; }
.quoteblock > .title { margin-left: -1.5em; margin-bottom: 0.75em; }
.quoteblock blockquote, .quoteblock blockquote p { color: #333333; font-size: 1.15rem; line-height: 1.75; word-spacing: 0.1em; letter-spacing: 0; font-style: italic; text-align: justify; }
.quoteblock blockquote { margin: 0; padding: 0; border: 0; }
.quoteblock blockquote:before { content: "\201c"; float: left; font-size: 2.75em; font-weight: bold; line-height: 0.6em; margin-left: -0.6em; color: #003b6b; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: 0.5em; margin-right: 0.5ex; text-align: right; }
.quoteblock .quoteblock { margin-left: 0; margin-right: 0; padding: 0.5em 0; border-left: 3px solid #e15200; }
.quoteblock .quoteblock blockquote { padding: 0 0 0 0.75em; }
.quoteblock .quoteblock blockquote:before { display: none; }

.verseblock { margin: 0 1em 0.75em 1em; }
.verseblock pre { font-family: "Open Sans", "DejaVu Sans", sans; font-size: 1.15rem; color: #333333; font-weight: 300; text-rendering: optimizeLegibility; }
.verseblock pre strong { font-weight: 400; }
.verseblock .attribution { margin-top: 1.25rem; margin-left: 0.5ex; }

.quoteblock .attribution, .verseblock .attribution { font-size: 0.8125em; line-height: 1.45; font-style: italic; }
.quoteblock .attribution br, .verseblock .attribution br { display: none; }
.quoteblock .attribution cite, .verseblock .attribution cite { display: block; letter-spacing: -0.025em; color: #e15200; }

.quoteblock.abstract { margin: 0 0 0.75em 0; display: block; }
.quoteblock.abstract blockquote, .quoteblock.abstract blockquote p { text-align: left; word-spacing: 0; }
.quoteblock.abstract blockquote:before, .quoteblock.abstract blockquote p:first-of-type:before { display: none; }

table.tableblock { max-width: 100%; border-collapse: separate; }
table.tableblock td > .paragraph:last-child p > p:last-child, table.tableblock th > p:last-child, table.tableblock td > p:last-child { margin-bottom: 0; }

table.tableblock, th.tableblock, td.tableblock { border: 0 solid #d8d8ce; }

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock { border-width: 0 1px 1px 0; }

table.grid-all > tfoot > tr > .tableblock { border-width: 1px 1px 0 0; }

table.grid-cols > * > tr > .tableblock { border-width: 0 1px 0 0; }

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock { border-width: 0 0 1px 0; }

table.grid-rows > tfoot > tr > .tableblock { border-width: 1px 0 0 0; }

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child { border-right-width: 0; }

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock { border-bottom-width: 0; }

table.frame-all { border-width: 1px; }

table.frame-sides { border-width: 0 1px; }

table.frame-topbot { border-width: 1px 0; }

th.halign-left, td.halign-left { text-align: left; }

th.halign-right, td.halign-right { text-align: right; }

th.halign-center, td.halign-center { text-align: center; }

th.valign-top, td.valign-top { vertical-align: top; }

th.valign-bottom, td.valign-bottom { vertical-align: bottom; }

th.valign-middle, td.valign-middle { vertical-align: middle; }

table thead th, table tfoot th { font-weight: bold; }

tbody tr th { display: table-cell; line-height: 1.4; background: -webkit-linear-gradient(top, #add386, #90b66a); }

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p { color: white; font-weight: bold; }

p.tableblock > code:only-child { background: none; padding: 0; }

p.tableblock { font-size: 1em; }

td > div.verse { white-space: pre; }

ol { margin-left: 1.75em; }

ul li ol { margin-left: 1.5em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.375em; }

ul.checklist, ul.none, ol.none, ul.no-bullet, ol.no-bullet, ol.unnumbered, ul.unstyled, ol.unstyled { list-style-type: none; }

ul.no-bullet, ol.no-bullet, ol.unnumbered { margin-left: 0.625em; }

ul.unstyled, ol.unstyled { margin-left: 0; }

ul.checklist { margin-left: 0.625em; }

ul.checklist li > p:first-child > .fa-square-o:first-child, ul.checklist li > p:first-child > .fa-check-square-o:first-child { width: 1.25em; font-size: 0.8em; position: relative; bottom: 0.125em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.inline { display: -ms-flexbox; display: -webkit-box; display: flex; -ms-flex-flow: row wrap; -webkit-flex-flow: row wrap; flex-flow: row wrap; list-style: none; margin: 0 0 0.375em -0.75em; }

ul.inline > li { margin-left: 0.75em; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1, td.hdlist2 { vertical-align: top; padding: 0 0.625em; }

td.hdlist1 { font-weight: bold; padding-bottom: 0.75em; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist td:not([class]):first-child { padding: 0.4em 0.75em 0 0.75em; line-height: 1; vertical-align: top; }
.colist td:not([class]):first-child img { max-width: none; }
.colist td:not([class]):last-child { padding: 0.25em 0; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.25em 0.625em 1.25em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.25em 0 1.25em 0.625em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.125em; }

.image.left, .image.right { margin-top: 0.25em; margin-bottom: 0.25em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.625em; }
.image.right { margin-left: 0.625em; }

a.image { text-decoration: none; display: inline-block; }
a.image object { pointer-events: none; }

sup.footnote, sup.footnoteref { font-size: 0.875em; position: static; vertical-align: super; }
sup.footnote a, sup.footnoteref a { text-decoration: none; }
sup.footnote a:active, sup.footnoteref a:active { text-decoration: underline; }

#footnotes { padding-top: 0.75em; padding-bottom: 0.75em; margin-bottom: 0.625em; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -0.25em 0 0.75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.375em 0 0.225em; line-height: 1.3334; font-size: 0.875em; margin-left: 1.2em; margin-bottom: 0.2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; margin-left: -1.05em; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
#content #footnotes { margin-top: -0.625em; margin-bottom: 0; padding: 0.75em 0; }

.gist .file-data > table { border: 0; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > .fa { cursor: default; }
a span.icon > .fa { cursor: inherit; }

.admonitionblock td.icon [class^="fa icon-"] { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #004176; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum[data-value] { display: inline-block; color: #fff !important; background-color: black; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; font-size: 0.75em; width: 1.67em; height: 1.67em; line-height: 1.67em; font-family: "Open Sans", "DejaVu Sans", sans-serif; font-style: normal; font-weight: bold; }
.conum[data-value] * { color: #fff !important; }
.conum[data-value] + b { display: none; }
.conum[data-value]:after { content: attr(data-value); }
pre .conum[data-value] { position: relative; top: -0.125em; }

b.conum * { color: inherit !important; }

.conum:not([data-value]):empty { display: none; }

h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { border-bottom: 1px solid #dddddd; }

.sect1 { padding-bottom: 0; }

#toctitle { color: #00406F; font-weight: normal; margin-top: 1.5em; }

.sidebarblock { border-color: #aaa; }

code { -webkit-border-radius: 4px; border-radius: 4px; }

p.tableblock.header { color: #6d6e71; }

.literalblock pre, .listingblock pre { background: #eeeeee; }

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>LightningJ - Paywall.</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_overview">1.1. Overview</a></li>
<li><a href="#_license">1.2. License</a></li>
<li><a href="#_whats_new">1.3. Whats New</a></li>
<li><a href="#_roadmap">1.4. Roadmap</a></li>
<li><a href="#_release_distribution">1.5. Release Distribution</a>
<ul class="sectlevel3">
<li><a href="#_release_signature_key">1.5.1. Release Signature Key</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#gettingstarted">2. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">2.1. Prerequisites</a></li>
<li><a href="#_generating_a_starter_project">2.2. Generating a Starter Project</a></li>
<li><a href="#_configuring_the_project">2.3. Configuring the Project</a></li>
<li><a href="#_creating_the_rest_service">2.4. Creating the REST Service</a></li>
<li><a href="#_the_required_paymenthandler">2.5. The Required PaymentHandler</a>
<ul class="sectlevel3">
<li><a href="#_the_articledata_table">2.5.1. The ArticleData Table</a></li>
<li><a href="#_paymentdata_table">2.5.2. PaymentData Table</a></li>
<li><a href="#_the_paymenthandler">2.5.3. The PaymentHandler</a></li>
</ul>
</li>
<li><a href="#_the_javascript_frontend">2.6. The Javascript Frontend</a>
<ul class="sectlevel3">
<li><a href="#_the_html_page">2.6.1. The HTML Page</a></li>
<li><a href="#_the_javascript_part">2.6.2. The Javascript Part</a></li>
</ul>
</li>
<li><a href="#_starting_the_application">2.7. Starting the application.</a></li>
</ul>
</li>
<li><a href="#_paywall_core_components">3. Paywall Core Components</a>
<ul class="sectlevel2">
<li><a href="#paymenthandler">3.1. Payment Handler</a>
<ul class="sectlevel3">
<li><a href="#_implementing_a_payment_handler_using_spring_framework">3.1.1. Implementing a Payment Handler using Spring Framework</a></li>
<li><a href="#paymentdata">3.1.2. Payment Data</a></li>
</ul>
</li>
<li><a href="#_paymentrequired_annotation">3.2. @PaymentRequired Annotation</a>
<ul class="sectlevel3">
<li><a href="#_available_paymentrequired_parameters">3.2.1. Available @PaymentRequired Parameters</a></li>
<li><a href="#_examples_of_paymentrequired_annotations">3.2.2. Examples of @PaymentRequired Annotations</a></li>
<li><a href="#requestpolicyparameter">3.2.3. The Request Policy Parameter</a></li>
<li><a href="#orderrequestgeneratorparameter">3.2.4. The Order Request Generator Parameter</a></li>
</ul>
</li>
<li><a href="#_payment_flows">3.3. Payment Flows</a>
<ul class="sectlevel3">
<li><a href="#_local_payment_flow">3.3.1. Local Payment Flow</a></li>
</ul>
</li>
<li><a href="#_customizing_paywall_components">3.4. Customizing Paywall Components</a>
<ul class="sectlevel3">
<li><a href="#_custom_currencyconverter">3.4.1. Custom CurrencyConverter</a></li>
<li><a href="#_custom_lightninghandler">3.4.2. Custom LightningHandler</a></li>
<li><a href="#_custom_keymanager">3.4.3. Custom KeyManager</a></li>
<li><a href="#_custom_tokengenerator">3.4.4. Custom TokenGenerator</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_spring_and_springboot_api">4. Spring and SpringBoot API</a>
<ul class="sectlevel2">
<li><a href="#_available_profiles">4.1. Available Profiles</a>
<ul class="sectlevel3">
<li><a href="#_local_payment_flow_profile">4.1.1. Local Payment Flow Profile</a></li>
<li><a href="#_customizing_bean_configuration">4.1.2. Customizing Bean Configuration</a></li>
</ul>
</li>
<li><a href="#_the_paywall_interceptor_filter">4.2. The Paywall Interceptor (Filter)</a>
<ul class="sectlevel3">
<li><a href="#_interceptor_error_handling">4.2.1. Interceptor Error Handling</a></li>
<li><a href="#_paywall_data_as_xml_response_instead_of_json">4.2.2. Paywall Data as XML Response instead of JSON</a></li>
</ul>
</li>
<li><a href="#_available_spring_configuration_properties">4.3. Available Spring Configuration Properties</a></li>
<li><a href="#_available_supporting_services_end_points">4.4. Available Supporting Services End-Points</a>
<ul class="sectlevel3">
<li><a href="#_qr_code_generator_end_point">4.4.1. QR Code Generator End-Point</a></li>
<li><a href="#_check_settlement_end_point">4.4.2. Check Settlement End-Point</a></li>
<li><a href="#_check_settlement_websocket_end_point">4.4.3. Check Settlement WebSocket End-Point</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#javascriptapi">5. Javascript API</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites_2">5.1. Prerequisites</a></li>
<li><a href="#_the_paywallhttprequest_class">5.2. The PaywallHttpRequest Class</a>
<ul class="sectlevel3">
<li><a href="#_example_usages">5.2.1. Example Usages</a></li>
<li><a href="#_displaying_remaining_times">5.2.2. Displaying Remaining Times</a></li>
<li><a href="#_displaying_amount_with_a_given_unit">5.2.3. Displaying Amount with a Given Unit</a></li>
<li><a href="#_reusing_settlement_for_multiple_calls">5.2.4. Reusing Settlement for Multiple Calls</a></li>
<li><a href="#_calling_non_paywalled_services">5.2.5. Calling Non-Paywalled Services</a></li>
<li><a href="#_handling_links_from_the_invoice_json_object">5.2.6. Handling Links from the Invoice JSON Object</a></li>
<li><a href="#_error_handling">5.2.7. Error Handling</a></li>
<li><a href="#_available_paywallhttprequest_states">5.2.8. Available PaywallHttpRequest States</a></li>
<li><a href="#_available_events_generated_by_paywallhttprequest">5.2.9. Available Events Generated by PaywallHttpRequest</a></li>
</ul>
</li>
<li><a href="#_defined_json_data_structures">5.3. Defined JSON Data structures</a>
<ul class="sectlevel3">
<li><a href="#_invoice_json_object">5.3.1. Invoice JSON Object</a></li>
<li><a href="#_settlement_json_object">5.3.2. Settlement JSON Object</a></li>
<li><a href="#_paywall_error_json_object">5.3.3. Paywall Error JSON Object</a></li>
</ul>
</li>
<li><a href="#_javascript_doc">5.4. Javascript Doc</a></li>
</ul>
</li>
<li><a href="#_for_paywall_developers">6. For Paywall Developers</a>
<ul class="sectlevel2">
<li><a href="#_building">6.1. Building</a></li>
<li><a href="#_testing_the_framework">6.2. Testing the framework</a>
<ul class="sectlevel3">
<li><a href="#_unit_tests">6.2.1. Unit Tests</a></li>
<li><a href="#_integration_tests">6.2.2. Integration Tests</a></li>
<li><a href="#_functional_tests">6.2.3. Functional Tests</a></li>
<li><a href="#_pre_release_tests">6.2.4. Pre-Release Tests</a></li>
<li><a href="#_test_reports">6.2.5. Test Reports</a></li>
</ul>
</li>
<li><a href="#_generating_a_release">6.3. Generating a Release</a>
<ul class="sectlevel3">
<li><a href="#_gpg_sign_releases_using_smartcard">6.3.1. GPG Sign Releases using SmartCard</a></li>
<li><a href="#_uploading_archives_to_maven_central">6.3.2. Uploading Archives to Maven Central</a></li>
<li><a href="#_updating_the_website">6.3.3. Updating the Website</a></li>
<li><a href="#_creating_a_release_draft_in_github">6.3.4. Creating a Release Draft in GitHub</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>LightningJ - Paywall, Enabling Micropayments for Microservices.</em>
V unspecified, 2019-08-23</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LightningJ Paywall is a project aimed at providing a simple to use framework to implement micro-payment functionality to
Java oriented Web Services using the Lightning Network. It is built to support Spring Framework and Spring Boot.</p>
</div>
<div class="paragraph">
<p>More information and source code can be found on the <a href="https://github.com/lightningj-org/paywall">Github site</a>.
There it is possible to report issues and contribute code.</p>
</div>
<div class="paragraph">
<p>If you want updates on this project, follow <a href="https://twitter.com/LightningJ_org" class="bare">https://twitter.com/LightningJ_org</a> on twitter.</p>
</div>
<div class="paragraph">
<p><em>Important</em>: This API is still in beta and API methods might change before real production release.<br>
<strong>All use of this library is on your own risk.</strong></p>
</div>
<div class="sect2">
<h3 id="_overview">1.1. Overview</h3>
<div class="paragraph">
<p>The LightningJ Paywall Framework has a goal to provide micro payment functionality to web services in Java.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It contains a Java library with core functionality and a Spring Framework library for use in Spring and Spring Boot
applications.</p>
</li>
<li>
<p>REST Services can be annotated with a @PaymentRequired annotation, triggering the need for a payment flow.</p>
</li>
<li>
<p>The library uses a LND Lightning Node in the backend to manage invoices.</p>
</li>
<li>
<p>It provides a JavaScript library  extending the standard XMLHttpRequest class with paywall functionality,
automatically regenerating a request after settlement.</p>
</li>
<li>
<p>To minimize the latency times after settling an invoice is a WebSocket interface provided to push out
settlement data to the browser so it can regenerate the request as soon as possible.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The framework aims to simply cloud deployment by being as stateless as possible (on server side) by utilizing state in
encrypted and signed (JWT, Java Web Tokens) authentication tokens. This removes the need for stateful load balancers and
complex logic in a clustered environment.</p>
</div>
<div class="paragraph">
<p>In the initial step is all functionality contained in the same application, i.e connection
to Lightning Node and end-point for checking state, but in the future will more distributed configuration be available
in order to make the paywalled service to be as minimal as possible.</p>
</div>
<div class="paragraph">
<p>See <a href="#gettingstarted">Getting Started section</a> for a quick run through of the project.</p>
</div>
</div>
<div class="sect2">
<h3 id="_license">1.2. License</h3>
<div class="paragraph">
<p>This library is Open Source and released under the LGPL v3 License. A link
to the license agreement can be found <a href="LICENSE.txt">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_whats_new">1.3. Whats New</h3>
<div class="ulist">
<ul>
<li>
<p>0.1.0-beta, Inital release.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_roadmap">1.4. Roadmap</h3>
<div class="paragraph">
<p>The framework will improve overtime with features requested, some ideas of future
features are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Support HODL Invoices.</p>
</li>
<li>
<p>Javascript API should be packaged and uploaded to central repository.</p>
</li>
<li>
<p>Support a distributed payment flow other that local where lightning node connection
can be managed from a central system.</p>
</li>
<li>
<p>Improved PaymentEventBus, possibility to subscribe to payment related events.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_release_distribution">1.5. Release Distribution</h3>
<div class="paragraph">
<p>All releases of the LightningJ Paywall framework are uploaded to maven central to be used
with Maven or Gradle under the group <em>org.lightningj.paywall</em>.</p>
</div>
<div class="sect3">
<h4 id="_release_signature_key">1.5.1. Release Signature Key</h4>
<div class="paragraph">
<p>All releases are signed with the following <a href="lightningj-release-pubkey.asc">GPG Key</a>.</p>
</div>
<div class="paragraph">
<p>GPG Key Fingerprint:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>7C0F 80B8 BD9F E3B8 1388  4BA1 9515 B31D DD9B BCCD</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gettingstarted">2. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO Introduction.</p>
</div>
<div class="paragraph">
<p>In our example we will build a web service that provides a Bitcoin Price TA ( Technical Analysis ) Price Prediction
Service, with a guaranteed correct prediction rate of 50%, that we will paywall and charge 10 Satoshis per prediction.</p>
</div>
<div class="sect2">
<h3 id="_prerequisites">2.1. Prerequisites</h3>
<div class="paragraph">
<p>Before you start development you need to set the following in your test environment.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 8 or JDK 11 installed.</p>
</li>
<li>
<p>Access to a local LND node, version 0.7.0 or up, preferable on Bitcoin Testnet.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instructions to set up or install an LND node can be found at <a href="//TODO" class="bare">//TODO</a>, you will also
need to find the TLS certificate and the invoice.macaroon file generated after LND startups.</p>
</div>
<div class="paragraph">
<p>TODO test with invoice.macaroon.</p>
</div>
</div>
<div class="sect2">
<h3 id="_generating_a_starter_project">2.2. Generating a Starter Project</h3>
<div class="paragraph">
<p>In our example we will use Spring Boot to build the service and a good way to start a new project is to
go to <em><a href="https://start.spring.io/">start.spring.io</a></em> and generate a skeleton project structure.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paywall-ts-demo-start1.png" alt="paywall ts demo start1">
</div>
<div class="title">Figure 1. Sprint Boot Project Starter Site, Figure 2.1.</div>
</div>
<div class="paragraph">
<p>In this example is <em>Gradle</em> used with <em>Spring Boot 2.1.7</em>. Enter a <em>group</em>, a project name under <em>artifact</em> and
finally add the dependencies: <em>Spring Web Starter</em>, <em>WebSocket</em> and <em>Spring Data JPA</em> to the project before
clicking on <em>Generate the Project</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paywall-ts-demo-start2.png" alt="paywall ts demo start2">
</div>
<div class="title">Figure 2. Sprint Boot Project Starter Site, Figure 2.2.</div>
</div>
<div class="paragraph">
<p>Open up the downloaded ZIP in your favorite IDE and you will get a project structure similar to <em>Figure 2.3</em>.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paywall-ts-demo-proj-struct1.png" alt="paywall ts demo proj struct1">
</div>
<div class="title">Figure 3. Sprint Boot Initial Project Structure, Figure 2.3.</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_the_project">2.3. Configuring the Project</h3>
<div class="paragraph">
<p>First we need to add paywall dependencies to the file build.gradle:</p>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    plugins {
    	id 'org.springframework.boot' version '2.1.7.RELEASE'
    	id 'java'
    }

    apply plugin: 'io.spring.dependency-management'

    group = 'org.lightningj.paywall'
    version = '0.0.1-SNAPSHOT'
    sourceCompatibility = '1.8'

    repositories {
    	mavenCentral()
    }

    dependencies {
	    // TODO
	    // Add Paywall Spring dependency here
	    compile project(':paywall-spring')

	    // Optionally if you want to use mariadb database instead of in memory, uncomment:
	    // implementation 'org.mariadb.jdbc:mariadb-java-client:2.4.0'

    	implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    	implementation 'org.springframework.boot:spring-boot-starter-web'
    	implementation 'org.springframework.boot:spring-boot-starter-websocket'
    	testImplementation 'org.springframework.boot:spring-boot-starter-test'
    }</pre>
</div>
</div>
<div class="paragraph">
<p>Then we need to setup a minimum configuration in the file <em>src/main/resources/application.properties</em>.
Here we configure the current paywall profile: <em>paywall_local</em> and connection options to your local LND node
(to retrieve the connect string use the <em>lncli getinfo</em> command.)
as well as location of and password protecting the secret key signing and encrypting the JWT (Java Web Token, used
to prove the state of a specific payment in a stateless way).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">spring.profiles.active=paywall_local

paywall.lnd.hostname=test3
paywall.lnd.port=10000
paywall.lnd.tlscertpath=/tmp/tlscertpath
paywall.lnd.macaroonpath=/tmp/macroonpath
paywall.lnd.connectstring=8371729292821728191012918129172271827281262611282@10.10.10.1:9735

paywall.keys.keystorepath=~/ta-demo-keys
paywall.keys.password=foobar123</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to use mariadb as database instead of the in-memory provided by default also
add the following properties, assuming your mariadb database is called <em>paywallTSDemo</em> (also remember
to add the <em>mariadb-java-client</em> dependency in <em>build.gradle</em>):</p>
</div>
<div class="paragraph">
<p>TODO Test that this works.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">spring.jpa.hibernate.ddl-auto=create
spring.datasource.url=jdbc:mariadb://localhost:3306/paywallTSDemo
spring.datasource.username=paywalltsdemouser
spring.datasource.password=foo124
spring.datasource.driver-class-name=org.mariadb.jdbc.Driver
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL5InnoDBDialect
spring.jpa.hibernate.naming.implicit-strategy=org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyHbmImpl
spring.jpa.hibernate.naming.physical-strategy=org.springframework.boot.orm.jpa.hibernate.SpringPhysicalNamingStrategy</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_rest_service">2.4. Creating the REST Service</h3>
<div class="paragraph">
<p>Next we create our TA Prediction Service that we want to paywall. It is a standard Spring RestController with
one method generating a JSON object TADemoResult when called and that is mapped to the URL <em>/tademo</em>.</p>
</div>
<div class="paragraph">
<p>The magic to require payment for the service is that we annotate it with @PaymentRequired with an article id of <em>tademo</em>
and indicates that payment should be done per request. If <em>payPerRequest</em> is set to false it will be possible for the
requester to perform multiple requests to the service until the settlement token issued after successful payment
is expires. In our example we want payment for every prediction we make.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RestController
public class TADemoRestController {

    private static final String template = "Bitcoin number is probably going %s.";
    private final AtomicLong counter = new AtomicLong();

    private final SecureRandom taEngine = new SecureRandom();

    @PaymentRequired(articleId = "tademo1", payPerRequest = true)
    @RequestMapping("/tademo")
    public TADemoResult tademo() {
        boolean goingUp = taEngine.nextBoolean();
        return new TADemoResult(counter.incrementAndGet(),
                String.format(template, (goingUp ? "up":"down")),
                goingUp);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON result we return from our service contains an id of this object, a prediction of future price and
a boolean, indicating up or down, that can be used in css styling of the HTML. This class has no Paywall
specific in it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class TADemoResult {

    private long id;
    private String prediction;
    private boolean goingUp;

    public TADemoResult(long id, String prediction, boolean goingUp) {
        this.id = id;
        this.prediction = prediction;
        this.goingUp = goingUp;
    }

    public long getId() {
        return id;
    }

    public String getPrediction() {
        return prediction;
    }

    public void setId(long id) {
        this.id = id;
    }

    public void setPrediction(String prediction) {
        this.prediction = prediction;
    }

    public boolean isGoingUp() {
        return goingUp;
    }

    public void setGoingUp(boolean goingUp) {
        this.goingUp = goingUp;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_required_paymenthandler">2.5. The Required PaymentHandler</h3>
<div class="paragraph">
<p>The Paywall Framework requires one component to be implemented by the target application. And that is a PaymentHandler.
It is in charge of creating and maintaining PaymentData, i.e. value objects about a payment that goes through the
payment flow (order, invoice, settlement) and persist them.</p>
</div>
<div class="paragraph">
<p>The PaymentHandler we will implement will use two database tables. One is ArticleData, containing an
article id to price relation in order to avoid hard coding the price for a given service. The other is table is
if type PaymentData that support pay per request calls. We call this class DemoPerRequestPaymentData.</p>
</div>
<div class="paragraph">
<p>Finally we will implement the actual PaymentHandler by extending the Spring Framework specific base version of
PaymentHandlers.</p>
</div>
<div class="sect3">
<h4 id="_the_articledata_table">2.5.1. The ArticleData Table</h4>
<div class="paragraph">
<p>First we create the ArticleData object that is mapped to a database table using Spring Data JPA framework.</p>
</div>
<div class="paragraph">
<p>It&#8217;s a very simple table, It contains an <em>unique id</em>, an <em>articleId</em> used in @PaymentRequired annotations and
a <em>price</em> used in generated orders.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class ArticleData {

    @Id
    @GeneratedValue(strategy= GenerationType.AUTO)
    private Integer id;
    @Column(nullable = false, unique = true)
    private String articleId;
    private long price;

    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getArticleId() {
        return articleId;
    }

    public void setArticleId(String articleId) {
        this.articleId = articleId;
    }

    public long getPrice() {
        return price;
    }

    public void setPrice(long price) {
        this.price = price;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we create a CrudRepository for the class that have one method <em>findByArticleId</em> used to fetch
ArticleData by it&#8217;s articleId.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface ArticleDataRepository extends CrudRepository&lt;ArticleData,Integer&gt; {
    ArticleData findByArticleId(String articleId);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_paymentdata_table">2.5.2. PaymentData Table</h4>
<div class="paragraph">
<p>Next is to create the PaymentData table. We will create a payment data containing minimal information to support pay per
request payment flows. It contains a unique identifier of the payment flow (<em>preImageHash</em>) the amount
invoiced and flags indicating if payment have been settled and executed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class DemoPerRequestPaymentData implements PerRequestPaymentData {

    @Id
    @GeneratedValue(strategy= GenerationType.AUTO)
    private Integer id;

    @Column(nullable = false)
    private String preImageHash;

    private long orderAmount;

    private boolean settled = false;

    private boolean payPerRequest = false;

    private boolean executed = false;

    /**
     * @return Unique Id of database row.
     */
    public Integer getId() {
        return id;
    }

    /**
     * @param id Unique Id of database row.
     */
    public void setId(Integer id) {
        this.id = id;
    }

    /**
     * Unique identifier of a payment in the system and also used in LightningHandler
     * to identify an invoice. Should be generated by TokenGenerator when
     * creating an order and not set manually.
     *
     * @return the unique identifier of a payment.
     */
    @Override
    public byte[] getPreImageHash() {
        return Base58.decode(this.preImageHash);
    }

    /**
     * @param preImageHash unique identifier of a payment in the system and also used in LightningHandler
     * to identify an invoice. Should be generated by TokenGenerator when
     * creating an order and not set manually.
     */
    @Override
    public void setPreImageHash(byte[] preImageHash) {
        this.preImageHash = Base58.encodeToString(preImageHash);
    }

    /**
     * @return the requested amount for payment. This can be either a FiatAmount or CryptoAmount but
     * always make sure the systems configured CurrencyConverter supports this currency when converting
     * into a currency accepted by the LightningHandler later in the payment flow.
     */
    @Override
    public Amount getOrderAmount() {
        return new BTC(orderAmount);
    }

    /**
     * @param orderAmount the requested amount for payment. This can be either a FiatAmount or CryptoAmount but
     * always make sure the systems configured CurrencyConverter supports this currency when converting
     * into a currency accepted by the LightningHandler later in the payment flow.
     */
    @Override
    public void setOrderAmount(Amount orderAmount) {
        assert orderAmount instanceof CryptoAmount;
        this.orderAmount = ((CryptoAmount) orderAmount).getValue();
    }

    /**
     * @return true if related invoice have been settled in full.
     */
    @Override
    public boolean isSettled() {
        return this.settled;
    }

    /**
     * @param settled true if related invoice have been settled in full.
     */
    @Override
    public void setSettled(boolean settled) {
        this.settled = settled;
    }

    /**
     * @return flag indicating that this payment is for one request only. The implementation
     * can take the payPerRequest flag from the order request as guidance, but it is the PaymentHandler
     * that ultimately decides if payPerRequest should be set.
     */
    @Override
    public boolean isPayPerRequest() {
        return payPerRequest;
    }

    /**
     * @param payPerRequest flag indicating that this payment is for one request only. The implementation
     * can take the payPerRequest flag from the order request as guidance, but it is the PaymentHandler
     * that ultimately decides if payPerRequest should be set.
     */
    @Override
    public void setPayPerRequest(boolean payPerRequest) {
        this.payPerRequest = payPerRequest;
    }

    /**
     * @return true if related request have been executed, is set after successful processing
     * if a payed call and used to indicate that it cannot be processed again.
     */
    @Override
    public boolean isExecuted() {
        return executed;
    }

    /**
     * @param executed true if related request have been executed, is set after successful processing
     * if a payed call and used to indicate that it cannot be processed again.
     */
    @Override
    public void setExecuted(boolean executed) {
        this.executed = executed;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also create a simple CrudRepository finding PaymentData for a given <em>preImageHash</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * Spring Data repository for DemoPerRequestPaymentData.
 */
public interface DemoPerRequestPaymentDataRepository extends CrudRepository&lt;DemoPerRequestPaymentData,Integer&gt; {

    DemoPerRequestPaymentData findByPreImageHash(String preImageHash);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_paymenthandler">2.5.3. The PaymentHandler</h4>
<div class="paragraph">
<p>Finally we create the actual <em>PaymentHandler</em> bean. Below is an example implementation of a component
that extends the SpringPaymentHandler and that lookups up a article id and create an PaymentData and maintains it
during the payment flow.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Bean Registration</dt>
<dd>
<p>The class is annotated with the <em>@Component("paymentHandler")</em> that register it as a bean
with name <em>paymentHandler</em> so other beans withing Paywall Framework can find it. It is also recommended to
add the <em>@ComponentScan("org.lightningj.paywall.spring")</em> as a convention to notify the application to scan the
package <em>org.lightningj.paywall.spring</em> for bean configurations and it that way initialize the framework.</p>
</dd>
<dt class="hdlist1">After Initialisation</dt>
<dd>
<p>The method afterPropertiesSet() is called after the bean in created and in this
case used to bootstrap the article database if not configured. This is optional but if used it is important to remember
to call <em>super.afterPropertiesSet()</em>.</p>
</dd>
<dt class="hdlist1">newPaymentData Method</dt>
<dd>
<p>This is one of three required methods to implement. It receives an OrderRequest,
looks up the price from the article id and creates a new PaymentData that is persisted to database.</p>
</dd>
<dt class="hdlist1">findPaymentData Method</dt>
<dd>
<p>This method should lookup the related payment data from the unique <em>preImageHash</em> from
database.</p>
</dd>
<dt class="hdlist1">updatePaymentData</dt>
<dd>
<p>This method should persist the state of PaymentData whenever a related
payment event is triggered in the payment flow.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Below is the implementation of the <em>PaymentHandler</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ComponentScan("org.lightningj.paywall.spring")
@Component("paymentHandler")
public class DemoPaymentHandler extends SpringPaymentHandler {

    @Autowired
    DemoPerRequestPaymentDataRepository demoPaymentDataRepository;

    @Autowired
    ArticleDataRepository articleDataRepository;

    /**
     * Method called after initialization of bean.
     *
     * Contains bootstrap of article database.
     */
    @Override
    public void afterPropertiesSet() throws Exception {
        // Important call afterPropertiesSet from SpringPaymentHandler
        super.afterPropertiesSet();

        ArticleData articleData1 = articleDataRepository.findByArticleId("tademo1");
        if(articleData1 == null){
            articleData1 = new ArticleData();
            articleData1.setArticleId("tademo1");
            articleData1.setPrice(10);
            articleDataRepository.save(articleData1);
        }
    }

    /**
     * Method that should generate a new PaymentData for a given order request.
     * This is the first call in a payment flow and the implementation should
     * look up the order amount from the article id, units and other options in
     * the order request.
     * &lt;p&gt;
     * The generated PaymentData should be at least MinimalPaymentData with preImageHash
     * and orderedAmount set.
     * &lt;p&gt;
     * It is recommended that the PaymentData is persisted in this call but could
     * be skipped for performance in certain payment flows.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @param orderRequest the specification of the payment data that should be created calculated
     *                     from data in the PaymentRequired annotation.
     * @return a newly generated PaymentData signaling a new payment flow used to
     * create an Order value object.
     * @throws IOException            if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred generating new payment data.
     */
    @Override
    protected PaymentData newPaymentData(byte[] preImageHash, OrderRequest orderRequest) throws IOException, InternalErrorException {
        try{
            DemoPerRequestPaymentData demoPaymentData = new DemoPerRequestPaymentData();
            demoPaymentData.setPreImageHash(preImageHash);
            demoPaymentData.setPayPerRequest(orderRequest.isPayPerRequest());

            long orderPrice = findArticleById(orderRequest.getArticleId()).getPrice() * orderRequest.getUnits(); // Price in satoshis.
            demoPaymentData.setOrderAmount(new BTC(orderPrice));

            demoPaymentDataRepository.save(demoPaymentData);
            return demoPaymentData;
        }catch(Exception e){
            if(e instanceof InternalErrorException){
                throw e;
            }
            throw new InternalErrorException("Error occurred saving DemoPaymentData to database: " + e.getMessage(),e);
        }
    }

    /**
     * Method to lookup a payment data in the payment handler.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @return return related payment data or null if not found.
     * @throws InternalErrorException if internal exception occurred fetching related payment data.
     */
    @Override
    protected PaymentData findPaymentData(byte[] preImageHash) throws InternalErrorException {
        try{
          return demoPaymentDataRepository.findByPreImageHash(Base58.encodeToString(preImageHash));
        }catch(Exception e){
          throw new InternalErrorException("Error occurred fetching DemoPaymentData from database: " + e.getMessage(),e);
        }
    }

    /**
     * Method called on update events about a given payment data. This could be when
     * the payment is added as invoice in LND and contains complementary data or when
     * the invoice was settled and contains settled flag set and settled amount and date
     * (depending on the type of PaymentData used in PaymentHandler).
     * &lt;p&gt;
     * The related payment data (using preImageHash as unique identifier) is automatically
     * looked up and the implementing method should at least persist the updated data.
     *
     * @param type        the type of event such as INVOICE_CREATED or INVOICE_SETTLED.
     * @param paymentData the payment data to update and persist.
     * @param context     the latest known state of the lightning handler.  Null if no known state exists.
     * @throws InternalErrorException if internal exception occurred updating related payment data.
     */
    @Override
    protected void updatePaymentData(PaymentEventType type, PaymentData paymentData, LightningHandlerContext context) throws InternalErrorException {
        try {
            assert paymentData instanceof DemoPerRequestPaymentData;
            demoPaymentDataRepository.save((DemoPerRequestPaymentData) paymentData);
        }catch(Exception e){
            throw new InternalErrorException("Error occurred updating DemoPaymentData to database: " + e.getMessage(),e);
        }
    }

    private ArticleData findArticleById(String articleId) throws InternalErrorException{
        ArticleData articleData = articleDataRepository.findByArticleId(articleId);
        if(articleData == null){
            throw new InternalErrorException("Internal error creating payment data, article id " + articleId + " doesn't exist in database.");
        }
        return articleData;
    }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_javascript_frontend">2.6. The Javascript Frontend</h3>
<div class="paragraph">
<p>The final component that needs to be updated in order to support Lightning payments is the web site front end should
display an invoice to the user. The TA application it-self is a very simple one-page html page with Bootstrap styling to
make it a bit more pretty.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paywall-ts-demo-web1.png" alt="paywall ts demo web1">
</div>
<div class="title">Figure 4. TA Prediction Web Page, Figure 2.4.</div>
</div>
<div class="paragraph">
<p>What we want is to add automatic display of invoice when needed and it should close automatically when settled as shown
in figure 2.5.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/paywall-ts-demo-invoice.png" alt="paywall ts demo invoice">
</div>
<div class="title">Figure 5. TA Prediction Invoice, Figure 2.5.</div>
</div>
<div class="sect3">
<h4 id="_the_html_page">2.6.1. The HTML Page</h4>
<div class="paragraph">
<p>We start with creating a index.html file that uses the three required Javascript files, sockjs.js, stomp.js and
paywall.js. The page also have a welcome section and a prediction display section, that is shown once the prediction
is downloaded from the paywalled REST service. There also exists a modal section that will be shown as soon as an invoice
is received.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">&lt;!doctype html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;!-- Required meta tags --&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"&gt;
    &lt;!-- Bootstrap CSS --&gt;
    &lt;link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"&gt;
    &lt;title&gt;Lightning J, Paywall TA Demo&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;nav class="navbar navbar-expand-md navbar-dark bg-dark"&gt;
    &lt;div class="navbar-collapse collapse w-100 order-1 order-md-0 dual-collapse2"&gt;
        &lt;a class="navbar-brand justify-content-left" href="#"&gt;LightningJ Paywall TA Demo&lt;/a&gt;
    &lt;/div&gt;
    &lt;div class="navbar-collapse collapse w-100 order-3 dual-collapse2"&gt;
        &lt;ul class="navbar-nav ml-auto"&gt;
            &lt;li class="nav-item"&gt;
                &lt;a class="nav-link" href="https://paywall.lightningj.org"&gt;Project Doc&lt;/a&gt;
            &lt;/li&gt;
            &lt;li class="nav-item"&gt;
                &lt;a class="nav-link" href="https://github.com/lightningj-org/paywall"&gt;GitHub&lt;/a&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
&lt;/nav&gt;
&lt;div id="welcomeCard" class="card" &gt;
    &lt;div class="card-body"&gt;
        &lt;h5 class="card-title"&gt;Bitcoin Price Prediction Service&lt;/h5&gt;
        &lt;h6 class="card-subtitle mb-2 text-muted"&gt;&lt;i&gt;Cost:&lt;/i&gt; 10 Satoshis&lt;/h6&gt;
        &lt;p class="card-text"&gt;Click on button below do receive a Bitcoin price indication with guaranteed 50% prediction accuracy.&lt;/p&gt;
        &lt;button id="welcomeCardBuyButton" type="button" class="btn btn-primary"&gt;Buy Prediction&lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div id="predictionCard" class="card d-none" &gt;
    &lt;div class="card-body"&gt;
        &lt;h5 class="card-title"&gt;Bitcoin Prediction Generated&lt;/h5&gt;
        &lt;p id="predictionText" class="card-text text-white"&gt;&lt;/p&gt;
        &lt;button id="predictionCardBuyButton" type="button" class="btn btn-primary"&gt;Buy New Prediction&lt;/button&gt;
        &lt;button id="predictionCardResetButton" type="button" class="btn btn-primary"&gt;Reset&lt;/button&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div id="invoiceModal" class="modal" tabindex="-1" role="dialog"&gt;
    &lt;div class="modal-dialog" role="document"&gt;
        &lt;div class="modal-content"&gt;
            &lt;div class="modal-header"&gt;
                &lt;h5 class="modal-title"&gt;Invoice Received&lt;/h5&gt;
                &lt;button type="button" class="close" data-dismiss="modal" aria-label="Close"&gt;
                    &lt;span aria-hidden="true"&gt;&amp;times;&lt;/span&gt;
                &lt;/button&gt;
            &lt;/div&gt;
            &lt;div id="invoiceModalBody" class="modal-body"&gt;
            &lt;/div&gt;
            &lt;div class="modal-footer justify-content-left"&gt;
                &lt;button type="button" class="btn btn-secondary mr-auto" data-dismiss="modal"&gt;Cancel&lt;/button&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;div class="fixed-bottom bg-secondary text-white"&gt;&lt;i&gt;Disclamer:&lt;/i&gt; This is not a real TA application. This is just a demo of LightingJ Paywall Framework. Do NOT consider this as financial advice in any way.&lt;/div&gt;

&lt;!-- TODO reference external scripts --&gt;
&lt;script src="js/sockjs.js" &gt;&lt;/script&gt;
&lt;script src="js/stomp.js" &gt;&lt;/script&gt;
&lt;script src="js/paywall.js" &gt;&lt;/script&gt;

&lt;!-- Optional JavaScript --&gt;
&lt;!-- jQuery first, then Popper.js, then Bootstrap JS --&gt;
&lt;script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"&gt;&lt;/script&gt;
&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"&gt;&lt;/script&gt;
&lt;script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"&gt;&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_javascript_part">2.6.2. The Javascript Part</h4>
<div class="paragraph">
<p>How the TA REST Service would usually be called to fetch JSON is done by XMLHttpRequest as shown in the example below.
This is what we need to enhance to support payments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">        function requestTA(){
            var xmlHttpRequest = new XMLHttpRequest();

            // Create onload event handler called after loading of JSON was complete.
            xmlHttpRequest.onload = function(){
                if(xmlHttpRequest.status === 200) {
                    // Process the service response as would be done with a regular XMLHttpRequest
                    var response = JSON.parse(xmlHttpRequest.responseText);
                    // Update web page using JSON response
                }else{
                    // Error calling the underlying service.
                    console.log(xmlHttpRequest.responseText)
                    alert("Error occurred calling the service.")
                }
            };

            // Open up a connection to the paywalled service.
            xmlHttpRequest.open("GET","/tademo");
            // Send the data to the service that will trigger the payment flow if required.
            xmlHttpRequest.send();
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we need to do is to replace the <em>XMLHttpRequest</em> with an instance of <em>PaywallHttpRequest</em> (that extends standard XMLHttpRequest with
paywall functionality) and add a few new event handlers for handling invoice and settlement.</p>
</div>
<div class="paragraph">
<p>After that we need to add three event handlers (It is possible to add more, but there are the minimum when creating a
pay per request application):</p>
</div>
<div class="paragraph">
<p>InvoiceListener::An event listener that will recieve the invoice generated by the Paywall API and that contains
all information needed to display the invoice. There is also help methods to display amount in different units
(Satoshis in this example) and creates an invoice expiration countdown timer. The event handler will also display
the invoice modal.</p>
</div>
<div class="paragraph">
<p>SettledListener::This eventhandler will cloase the invoice modal since <em>PaywallHttpRequest</em> have autoamtically
called the REST service again as soon as it recieved payment.</p>
</div>
<div class="paragraph">
<p>InvoiceExpiredListener::This evenhandler removes all invoice data in the invoice modal and prints
<em>Invoice Expired</em> instead.</p>
</div>
<div class="paragraph">
<p>See example below for replacement for the previous code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">        function requestTA(){
            var paywallHttpRequest = new PaywallHttpRequest();

            var invoiceExpireTimer;

            // The invoice expiration that updates the remaining time.
            function updateIntervalTime(){
                var invoiceRemainingTime = paywallHttpRequest.paywall.getInvoiceExpiration().remaining();
                var remainingTime = invoiceRemainingTime.minutes() + ":" + invoiceRemainingTime.seconds();
                $('#invoiceTimeRemaining').text(remainingTime);
            }

            // The Invoice event handler that adds invoice information to the modal and then displays it.
            paywallHttpRequest.paywall.addEventListener("InvoiceListener", PaywallEventType.INVOICE, function (type, invoice) {
                // Add a Paywall Invoice event Listener that displays the invoice for the user.
                var modalBody = $('#invoiceModalBody')
                modalBody.empty();
                var invoiceExpire = new PaywallTime(invoice.invoiceExpireDate)
                modalBody.append("&lt;h6 class='text-center'&gt;Invoice Expires In: &lt;span id='invoiceTimeRemaining'&gt;" + invoiceExpire.remaining().minutes() + ":" + invoiceExpire.remaining().seconds() + "&lt;/span&gt;&lt;/h6&gt;") // Time Left
                modalBody.append("&lt;img class='mx-auto d-block' src='" + invoice.qrLink + "'/&gt;"); // QR
                var amountInSat = new PaywallAmount(invoice.invoiceAmount).as(BTCUnit.SAT);
                modalBody.append("&lt;h6&gt;Price: " + amountInSat + "&lt;/h6&gt;") // Time Left
                modalBody.append("&lt;div class=\"accordion\" id=\"advancedAccordion\"&gt;\n" +
                    "    &lt;div id=\"welcomeCard2\" class=\"card\" &gt;\n" +
                    "        &lt;div class=\"card-header\" id=\"advancedAccordionHeader\"&gt;\n" +
                    "            &lt;h6 class=\"mb-0\"&gt;\n" +
                    "                &lt;button class=\"btn btn-link\" type=\"button\" data-toggle=\"collapse\" data-target=\"#advancedAccordionBody\" aria-expanded=\"false\" aria-controls=\"advancedAccordionBody\"&gt;\n" +
                    "                    Advanced\n" +
                    "                &lt;/button&gt;\n" +
                    "            &lt;/h6&gt;\n" +
                    "        &lt;/div&gt;\n" +
                    "      &lt;div id=\"advancedAccordionBody\" class=\"collapse\" aria-labelledby=\"advancedAccordionHeader\" data-parent=\"#advancedAccordion\"&gt;\n" +
                    "            &lt;div class=\"card-body\"&gt;\n" +
                    "                &lt;div class=\"card\" &gt;\n" +
                    "                    &lt;div class=\"card-body\"&gt;\n" +
                    "                        &lt;h6 class=\"card-subtitle mb-2 text-muted\"&gt;&lt;i&gt;Invoice:&lt;/i&gt;&lt;/h6&gt;\n" +
                    "                        &lt;p id=\"bolt11Invoice\" class=\"card-text\"&gt;" + invoice.bolt11Invoice + "&lt;/p&gt;\n" +
                    "                    &lt;/div&gt;\n" +
                    "                &lt;/div&gt;\n" +
                    "                &lt;div class=\"card\" &gt;\n" +
                    "                    &lt;div class=\"card-body\"&gt;\n" +
                    "                        &lt;h6 class=\"card-subtitle mb-2 text-muted\"&gt;&lt;i&gt;Node Info:&lt;/i&gt;&lt;/h6&gt;\n" +
                    "                        &lt;p id=\"nodeInfo\" class=\"card-text\"&gt;" + invoice.nodeInfo.connectString + "&lt;/p&gt;\n" +
                    "                    &lt;/div&gt;\n" +
                    "                &lt;/div&gt;\n" +
                    "            &lt;/div&gt;\n" +
                    "        &lt;/div&gt;\n" +
                    "      &lt;/div&gt;\n" +
                    "   &lt;/div&gt;"); // Advanced, with invoice and node

                 // Set the timer
                invoiceExpireTimer = setInterval(updateIntervalTime,1000);

                // Finally activate the invoice modal.
                $('#invoiceModal').modal({});
            });

            // Event listener that hides the modal upon settlement.
            paywallHttpRequest.paywall.addEventListener("SettledListener", PaywallEventType.SETTLED, function (type, settlement) {
                $('#invoiceModal').modal('hide');
            });

            // Event listener that updates the modal with invoice expired information.
            paywallHttpRequest.paywall.addEventListener("InvoiceExpiredListener", PaywallEventType.INVOICE_EXPIRED, function (type, invoice) {
                var modalBody = $('#invoiceModalBody')
                modalBody.empty();
                modalBody.append("&lt;h6 class='text-center'&gt;Invoice Expired&lt;/h6&gt;") // Time Left
            });

            // The same onload handler that should have been used without paywall to call the service.
            paywallHttpRequest.onload = function(){
                if(paywallHttpRequest.status === 200) {
                    // Process the service response as would be done with a regular XMLHttpRequest
                    var response = JSON.parse(paywallHttpRequest.responseText);
                    var predictionText = $('#predictionText')
                    predictionText.text(response.prediction);
                    if (response.goingUp) {
                        predictionText.removeClass("bg-danger");
                        predictionText.addClass("bg-success");
                    } else {
                        predictionText.removeClass("bg-success");
                        predictionText.addClass("bg-danger");
                    }
                    $('#welcomeCard').addClass("d-none");
                    $('#predictionCard').removeClass("d-none");
                }else{
                    // Error calling the underlying service.
                    console.log(paywallHttpRequest.responseText)
                    alert("Error occurred calling the service.")
                }
            };

            // Open up a connection to the paywalled service.
            paywallHttpRequest.open("GET","/tademo");
            // Send the data to the service that will trigger the payment flow if required.
            paywallHttpRequest.send();

        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we also add a event handler specific for the Bootstrap modal that listens to close modal events and
releases all underlying resources, such as closing web socket, etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">            $('#invoiceModal').on('hide.bs.modal', function (event) {
                console.log("Hidden: " + paywallHttpRequest.paywall.getState());
                if(invoiceExpireTimer !== undefined){
                    clearInterval(invoiceExpireTimer);
                }
                // Catch event that Invoice Modal is closes and free allocated resources by
                // calling the abort() method.
                if(paywallHttpRequest.paywall.getState() !== PaywallState.SETTLED &amp;&amp;
                    paywallHttpRequest.paywall.getState() !== PaywallState.EXECUTED) {
                    console.log("Aborted");
                    paywallHttpRequest.abort();
                }
            });</code></pre>
</div>
</div>
<div class="paragraph">
<p>The full index.html can be found in the example repository <a href="TODO">here</a>.</p>
</div>
<div class="paragraph">
<p>Also see <a href="#javascriptapi">Javascript API</a> section for more details on how to use the <em>PaywallHttpRequest</em> class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_starting_the_application">2.7. Starting the application.</h3>
<div class="paragraph">
<p>The final step to get the TA Demo application up an running in your development enviroment is by running
the command</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew bootRun</pre>
</div>
</div>
<div class="paragraph">
<p>Then open up the browser and go to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> and you are ready for starting to pay for TA predictions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_paywall_core_components">3. Paywall Core Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Paywall framework is built up of a set of core components controlling the payment flow and
most of them are customizable. This chapter goes through the core parts of these components that are not
directly Spring Framework specific.</p>
</div>
<div class="paragraph">
<p>First are the most basic concepts in Paywall Framework, and that are required when using the framework are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>PaymentHandler</em>, that creates, updates and persist <em>PaymentData</em>.</p>
</li>
<li>
<p><em>PaymentData</em>, value object of a given payment state.</p>
</li>
<li>
<p><em>@PaymentRequired</em>, annotation that is set on API services that should trigger a payment flow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then are the concept <em>PaymentFlow</em> described, that is in charge of directing the flow between
the different components.</p>
</div>
<div class="paragraph">
<p>Finally are other core components discussed, such as <em>LightningHandler</em> used to communicate with the lightning node, and
<em>CurrencyConverter</em> that is in charge of converting between FIAT and Crypto currency if needed.</p>
</div>
<div class="sect2">
<h3 id="paymenthandler">3.1. Payment Handler</h3>
<div class="paragraph">
<p>A PaymentHandler manages Orders, Invoices and Settlements in a payment flow and every application using Paywall
framework is required to implement one. The class is responsible to create and persist a value object of type
PaymentData.</p>
</div>
<div class="paragraph">
<p>A PaymentData that can be of different types depending on the level of control of the actual payment flow wanted or
the what types of payment related data that needs to be persisted.</p>
</div>
<div class="sect3">
<h4 id="_implementing_a_payment_handler_using_spring_framework">3.1.1. Implementing a Payment Handler using Spring Framework</h4>
<div class="paragraph">
<p>Using the Spring Framework, the easiest way to implement the payment handler is to create a class extending
<em>org.lightningj.paywall.spring.SpringPaymentHandler</em> and implement the following three methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">newPaymentData</dt>
<dd>
<p>Method that should generate a new PaymentData. The method receives a newly generated preImageHash, used
to uniquely identify the payment flow, and an OrderRequest, containing data from PaymentRequired annotation. This is the
first call in a payment flow and the implementation should for example look up the order amount from the article id,
units and other options in the order request. The generated PaymentData should be at least MinimalPaymentData with
preImageHash and orderedAmount set. It is recommended that the PaymentData is persisted in this call but could
be skipped for performance in certain payment flows.</p>
</dd>
<dt class="hdlist1">findPaymentData</dt>
<dd>
<p>Method used by the paywall framework to lookup a PaymentData from a preImageHash.</p>
</dd>
<dt class="hdlist1">updatePaymentData</dt>
<dd>
<p>Method called on update events about a given payment data. This could be when the payment is added
as invoice in LND and contains complementary data or when the invoice was settled and has the <em>settled</em> flag set along
with the settled amount (depending on the type of PaymentData used in PaymentHandler). The implementing method should at
least persist the updated payment data. See table <a href="#paymenteventtypes">Available Payment Event Types</a> for list of
different <em>PaymentEventType</em> that might occur.</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Table Available Payment Event Types</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ORDER_CREATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling a order was created. This event is never sent to updatePaymentData.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE_CREATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling that a payments invoice have been created by lightning handler.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE_SETTLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling that a invoice have been settled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUEST_EXECUTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Event signaling that a payed request has been executed. Only used for payment
  flows with payPerRequest flag set.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Below is an excerpts of the required methods to implement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    /**
     * Method that should generate a new PaymentData for a given order request.
     * This is the first call in a payment flow and the implementation should
     * look up the order amount from the article id, units and other options in
     * the order request.
     *
     * The generated PaymentData should be at least MinimalPaymentData with preImageHash
     * and orderedAmount set.
     *
     * It is recommended that the PaymentData is persisted in this call but could
     * be skipped for performance in certain payment flows.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @param orderRequest the specification of the payment data that should be created calculated
     *                     from data in the PaymentRequired annotation.
     * @return a newly generated PaymentData signaling a new payment flow used to
     * create an Order value object.
     * @throws IOException if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred generating new payment data.
     */
    protected abstract PaymentData newPaymentData(byte[] preImageHash, OrderRequest orderRequest) throws IOException, InternalErrorException;

    /**
     * Method to lookup a payment data in the payment handler.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @return return related payment data or null if not found.
     * @throws IOException if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred fetching related payment data.
     */
    protected abstract PaymentData findPaymentData(byte[] preImageHash) throws IOException, InternalErrorException;

    /**
     * Method called on update events about a given payment data. This could be when
     * the payment is added as invoice in LND and contains complementary data or when
     * the invoice was settled and contains settled flag set and settled amount and date
     * (depending on the type of PaymentData used in PaymentHandler).
     *
     * The related payment data (using preImageHash as unique identifier) is automatically
     * looked up and the implementing method should at least persist the updated data.
     *
     * @param type the type of event such as INVOICE_CREATED or INVOICE_SETTLED.
     * @param paymentData the payment data to update and persist.
     * @param context the latest known state of the lightning handler.  Null if no known state exists.
     * @throws IOException if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred updating related payment data.
     */
    protected abstract void updatePaymentData(PaymentEventType type, PaymentData paymentData,
                                          LightningHandlerContext context) throws IOException, InternalErrorException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is an example implementation for Spring Framework, that assumes you have Spring Data Repository for a
FullPaymentData implementation (see <a href="#paymentdata">PaymentData section</a> ), and that supports <em>payPerRequest</em> annotated
services. It also assumes there exists a Spring Data Repository for the Article Ids specified in @PaymentRequired
annotation to look up price for specified Article Id.</p>
</div>
<div class="paragraph">
<p>Using Spring it is important to add the class as a component with name <em>paymentHandler</em> using the
@Component("paymentHandler") annotation on the class level.</p>
</div>
<div class="paragraph">
<p><em>Important:</em> In order for your Spring application to load all beans in the Paywall framework it
is a requirement to also add an annotation <em>@ComponentScan("org.lightningj.paywall.spring")</em> above
one of the target application components, and it is recommended to do this for the PaymentHandler
as a convertion.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/**
 * Demo implementation of a Payment Handler extending SpringPaymentHandler.
 *
 * It creates DemoPaymentData that implements the PerRequestPaymentData interface. (In order to demonstrate
 * support for both request that's valid for a period of time and for a specific request.)
 * by first looking up the article id order (generated by the @PaymentRequired annotation).
 * Then checks the price of the article in ArticleData table to calculate the ordered amount.
 *
 * It also implements the lookup by preImageHash method and update payment data methods by calling
 * related methods in the DemoPaymentDataRepository.
 *
 */
 @ComponentScan("org.lightningj.paywall.spring")
@Component("paymentHandler")
public class DemoPaymentHandler extends SpringPaymentHandler {

    @Autowired
    DemoFullPaymentDataRepository demoPaymentDataRepository;

    @Autowired
    ArticleDataRepository articleDataRepository;

    /**
     * Method that should generate a new PaymentData for a given order request.
     * This is the first call in a payment flow and the implementation should
     * look up the order amount from the article id, units and other options in
     * the order request.
     * &lt;p&gt;
     * The generated PaymentData should be at least MinimalPaymentData with preImageHash
     * and orderedAmount set.
     * &lt;p&gt;
     * It is recommended that the PaymentData is persisted in this call but could
     * be skipped for performance in certain payment flows.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @param orderRequest the specification of the payment data that should be created calculated
     *                     from data in the PaymentRequired annotation.
     * @return a newly generated PaymentData signaling a new payment flow used to
     * create an Order value object.
     * @throws IOException            if communication exception occurred in underlying components.
     * @throws InternalErrorException if internal exception occurred generating new payment data.
     */
    @Override
    protected PaymentData newPaymentData(byte[] preImageHash, OrderRequest orderRequest) throws IOException, InternalErrorException {
        try{
            DemoFullPaymentData demoPaymentData = new DemoFullPaymentData();
            demoPaymentData.setPreImageHash(preImageHash);
            demoPaymentData.setPayPerRequest(orderRequest.isPayPerRequest());

            ArticleData articleData = articleDataRepository.findByArticleId(orderRequest.getArticleId());
            if(articleData == null){
                throw new InternalErrorException("Internal error creating payment data, article id " + orderRequest.getArticleId() + " doesn't exist in database.");
            }
            long orderPrice = articleData.getPrice() * orderRequest.getUnits(); // Price in satoshis.
            demoPaymentData.setOrderAmount(new BTC(orderPrice));

            demoPaymentDataRepository.save(demoPaymentData);
            return demoPaymentData;
        }catch(Exception e){
            if(e instanceof InternalErrorException){
                throw e;
            }
            throw new InternalErrorException("Error occurred saving DemoPaymentData to database: " + e.getMessage(),e);
        }
    }

    /**
     * Method to lookup a payment data in the payment handler.
     *
     * @param preImageHash the unique preImageHash used to identify a payment flow
     *                     withing a lightning payment.
     * @return return related payment data or null if not found.
     * @throws InternalErrorException if internal exception occurred fetching related payment data.
     */
    @Override
    protected PaymentData findPaymentData(byte[] preImageHash) throws InternalErrorException {
        try{
          return demoPaymentDataRepository.findByPreImageHash(Base58.encodeToString(preImageHash));
        }catch(Exception e){
          throw new InternalErrorException("Error occurred fetching DemoPaymentData from database: " + e.getMessage(),e);
        }
    }

    /**
     * Method called on update events about a given payment data. This could be when
     * the payment is added as invoice in LND and contains complementary data or when
     * the invoice was settled and contains settled flag set and settled amount and date
     * (depending on the type of PaymentData used in PaymentHandler).
     * &lt;p&gt;
     * The related payment data (using preImageHash as unique identifier) is automatically
     * looked up and the implementing method should at least persist the updated data.
     *
     * @param type        the type of event such as INVOICE_CREATED or INVOICE_SETTLED.
     * @param paymentData the payment data to update and persist.
     * @param context     the latest known state of the lightning handler.  Null if no known state exists.
     * @throws InternalErrorException if internal exception occurred updating related payment data.
     */
    @Override
    protected void updatePaymentData(PaymentEventType type, PaymentData paymentData, LightningHandlerContext context) throws InternalErrorException {
        try {
            assert paymentData instanceof DemoFullPaymentData;
            demoPaymentDataRepository.save((DemoFullPaymentData) paymentData);
        }catch(Exception e){
            throw new InternalErrorException("Error occurred updating DemoPaymentData to database: " + e.getMessage(),e);
        }
    }
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_advanced_paymenthandler_features">Advanced PaymentHandler Features</h5>
<div class="paragraph">
<p>For production ready implementations of a PaymentHandler it is recommended to also override and implement
the method <em>getLightningHandlerContext()</em>. It should return a LightningHandlerContext (i.e. a LNDLightningHandlerContext
if LND backend is used) that contains the latest position of subscribed invoices. This will make restarts of the
application more reliable since invoices that have been settled during a restart of the application will not be missed.</p>
</div>
<div class="paragraph">
<p>The LNDLightningHandlerContext contains two values <em>addIndex</em> and <em>settleIndex</em> indicating from which position the
LNDLightningHandler should start to subscribe to invoice events. When supporting  <em>getLightningHandlerContext()</em> should
the PaymentHandler implementation persist the two values from the LNDLightningHandlerContext received in the
<em>updatePaymentData</em> call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    /**
     * Method to generate the latest LightningHandlerContext of latest
     * known state of the lightning node. Used to make sure the PaymentHandler
     * starts listening on the correct location of the invoice event queue after
     * restart. For LND Nodes should this method return a LNDLightningHandlerContext
     * @return the last known state of lightning handler context.
     * @throws InternalErrorException if internal exception occurred fetching latest known state of lightning handler.
     */
    LightningHandlerContext getLightningHandlerContext() throws InternalErrorException;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="paymentdata">3.1.2. Payment Data</h4>
<div class="paragraph">
<p>PaymentData is a value object, usually stored in a database, that the <em>PaymentHandler</em> manages. There exists
several interfaces to choose from depending on required functionality. The simplest interface is MinimalPaymentData
and it contains the absolute minimal fields necessary to be able to complete a payment flow. And FullPaymentData where
it is possible for the PaymentHandler implementation to control many aspects of the payment flow such as invoice
validity, settlement validity.</p>
</div>
<div class="paragraph">
<p>Each sub-section describes the different types of PaymentData available.</p>
</div>
<div class="sect4">
<h5 id="_minimalpaymentdata">MinimalPaymentData</h5>
<div class="paragraph">
<p>Contains the minimum fields needed in order to support a payment flow, without possibility to host <em>payPerRequest</em> calls.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. Table Fields in MinimalPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preImageHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">byte[]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique identifier of a payment in the system and also used in LightningHandler to identify an invoice. Should be
generated by TokenGenerator when creating an order and not set manually.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">orderAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The requested amount for payment. This can be either a FiatAmount or CryptoAmount but
  always make sure the systems configured CurrencyConverter supports this currency when converting
  into a currency accepted by the LightningHandler later in the payment flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If related invoice have been settled in full.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/MinimalPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_perrequestpaymentdata">PerRequestPaymentData</h5>
<div class="paragraph">
<p>PerRequestPaymentData is a interface extending MinimalPaymentData required when pay per request functionality is used.
It adds two flags that indicate that this payment is payPerRequest and whether the settled call have been executed and
cannot be requested again.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. Table Fields in PerRequestPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payPerRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Flag indicating that this payment is for one request only. The implementation
  can take the payPerRequest flag from the order request as guidance, but it is the PaymentHandler
  that ultimately decides if payPerRequest should be set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">executed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if related request have been executed, is set after successful processing
  of a request and used to indicate that it cannot be processed again.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/PerRequestPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_standardpaymentdata">StandardPaymentData</h5>
<div class="paragraph">
<p>The StandardPaymentData extends MinimalPaymentData and adds more information about the invoice and the ability
for the PaymentHandler to control invoice validity and settlement validity.</p>
</div>
<div class="paragraph">
<p>_Note:_In order for a StandardPaymentData to support pay per request flows it has to also implement the PerRequestPaymentData
interface.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 4. Table Fields in StandardPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A short description of the payment used in the lightning invoice and might
  be displayed to the end user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CryptoAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount set in the lightning invoice, this is the same as orderAmount if
  the same currency is used in order as in lightning invoice, otherwise is the currency
  converted before creating the invoice in LightningHandler and the actual invoiced amount
  is specified here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The date the invoice was created in LightningHandler.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceExpireDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The date a generated invoice should expire, this value will be used
  when creating invoice in LightningHandler. If null will default invoice validity
  be used to calculate an expire date automatically.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settledAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CryptoAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount that was settled in the LightningHandlers supported crypto currency.
  Should be equal to invoiceAmount if fully settled. Null if invoice isn&#8217;t settled yet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The timestamp the invoice was settled in LightningHandler. Null if not settled yet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementDuration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Duration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The settlement duration indicates how long time a generated settlement should be valid. If
  not set will a default settlement value be used. In FullPaymentData it is also possible
  to specify an expiration date of an settlement that is used if it&#8217;s required to set a fixed time when
  the settlement should expire, for example if a settlement should be valid the entire day or month.
  <em>If settlement expire date is set it has precedence over settlementDuration.</em>
  <strong>Important:</strong> Data in this field is only set to instruct the settlement token generator of expiration date.
  the actual settlement date is not updated in this field.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/StandardPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_fullpaymentdata">FullPaymentData</h5>
<div class="paragraph">
<p>The FullPaymentData extends both StandardPaymentData and PerRequestPaymentData and adds fields to store
the actual bolt11Invoice and possiblity to specify exact dates for settlement validity, for use cases when
paying for instance for a monthly subscription for a service and want the settlement token to be valid for exactly
those dates.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 5. Table Fields in FullPaymentData</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bolt11Invoice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The bolt11 lightning invoice displayed to the end user before paying and invoice.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementValidFrom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The valid from timestamp used in generated settlement tokens. If null is no valid from used, only validUntil.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementExpireDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instant</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The settlement expire date sets the timestamp when a generated settlement token should expire. If
  not set will a settlementDuration be used, and if that is also null will default duration be set.
  This field is useful if a settlement should be valid the entire day or month. <em>If settlement expire date is set it has
  precedence over settlementDuration.</em>
  <strong>Important:</strong> Data in this field is only set to instruct the settlement token generator of expiration date.
  The actual settlement date is not updated in this field.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For more details see <a href="javadoc/org/lightningj/paywall/paymenthandler/data/FullPaymentData.html">JavaDoc</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_paymentrequired_annotation">3.2. @PaymentRequired Annotation</h3>
<div class="paragraph">
<p>Another of the main components of the framework is the @PaymentRequired annotation used to
mark that a service requires payment and initiates a new payment flow if needed.</p>
</div>
<div class="paragraph">
<p>Currently are only Spring REST Controllers (Annotated with @RestController) supported but other
types of services will be supported in the future.</p>
</div>
<div class="sect3">
<h4 id="_available_paymentrequired_parameters">3.2.1. Available @PaymentRequired Parameters</h4>
<div class="paragraph">
<p>The @PaymentRequired annotation can be customized to create order request information to
the payment handler in various ways. See table below for a full list of available parameters.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 6. Table Available PaymentRequired Parameters</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameters</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">articleId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true, see description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the type of order that should be generated, used by PaymentHandler to determine order amount depending
  on article an units. (Required if not a custom OrderRequestGenerator is specified).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">units</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of units for given article number.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payPerRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If payment is valid for one request only. If not will the settlement be valid for multiple request
  over a specified time period.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">orderRequestGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DefaultOrderRequestGenerator.class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Possibility to specify a custom order request generator, instead of the default one using
  the articleId and units to request an order. See section <a href="#orderrequestgeneratorparameter">Order Request Generator Parameter</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">requestPolicy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WITH_BODY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines what data in HTTP request that is considered relevant for determining a unique payment.
  See section <a href="#requestpolicyparameter">Request Policy Parameter</a> for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">customPolicy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NoCustomRequestPolicy.class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The custom class if none of the predefined request policy types isn&#8217;t applicable and a custom implementation is necessary.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paymentOptions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of custom extra options sent to payment handler when creating an order for an invoice. Each value should
  be of class org.lightningj.paywall.annotations.vo.PaymentOption that have two fields, <em>option</em> which acts as a key and <em>value</em> that contains
  the actual value.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_examples_of_paymentrequired_annotations">3.2.2. Examples of @PaymentRequired Annotations</h4>
<div class="paragraph">
<p>The @PaymentRequired annotation can be placed on either the method or class level. If placed before
the class declaration is all methods paywalled with the same parameters.</p>
</div>
<div class="paragraph">
<p>Below is an example of a pay walled method where a payment request request is initiated with article id "abc123"
sent the payment handler to create an order for.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RestController
public class Poc1RestController {

    private static final String template = "PocService1, %s!";
    private final AtomicLong counter = new AtomicLong();

    @PaymentRequired(articleId = "abc123")
    @RequestMapping("/poc1")
    public PocResult poc1(@RequestParam(value="name", defaultValue="Poc1") String name) {
        return new PocResult(counter.incrementAndGet(),
                String.format(template, name));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If payment should be done per-request and not for a specified time add a payPerRequest
parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RestController
public class Poc1RestController {

    private static final String template = "PocService1, %s!";
    private final AtomicLong counter = new AtomicLong();

    @PaymentRequired(articleId = "abc123", payPerRequest = true)
    @RequestMapping("/poc1")
    public PocResult poc1(@RequestParam(value="name", defaultValue="Poc1") String name) {
        return new PocResult(counter.incrementAndGet(),
                String.format(template, name));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If all methods should be pay walled in a class with the same parameters add the annotation
before the class declaration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@PaymentRequired(articleId = "abc456")
@RestController
public class Poc1RestController {

    private static final String template = "PocService1, %s!";
    private final AtomicLong counter = new AtomicLong();

    @RequestMapping("/poc1")
    public PocResult poc1(@RequestParam(value="name", defaultValue="Poc1") String name) {
        return new PocResult(counter.incrementAndGet(),
                String.format(template, name));
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="requestpolicyparameter">3.2.3. The Request Policy Parameter</h4>
<div class="paragraph">
<p>The request policy is in-charge of calculating a cryptographic hash of all significant data for
a given payment flow. This is used to determine if a given settlement is valid for a related request.</p>
</div>
<div class="paragraph">
<p>For example if a service should require payment for access to a given REST WebService for a given amount of time
it should specify URL_AND_METHOD and all types of requests to that URL and METHOD will be allowed
until the related settlement expires (given that <em>payPerRequest</em> is set to false). What happens under the hood is that
the URL and METHOD in the original request was included in the cryptographic hash and no other data. After successful
payment and when the same request is snet again will the new requests URL and HTTP method be matched against the
original one.</p>
</div>
<div class="paragraph">
<p>There exists a set of defined types of request policies that calculate the unique request
from a given set of data.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 7. Table Available Pre-defined Request Policy Options</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL_AND_METHOD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy that checks the URL and Method of a request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL_METHOD_AND_PARAMETERS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy that checks the URL and Method and all parameters of a request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WITH_BODY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy that checks the URL, Method, all parameters and full body data of a HTTP request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CUSTOM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Custom implementation of calculating significant request data.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_creating_a_custom_request_policy">Creating a Custom Request Policy</h5>
<div class="paragraph">
<p>To create a custom request policy, create a class that implements <em>org.lightningj.paywall.requestpolicy.RequestPolicy</em>.
It contains one required method significantRequestDataDigest that calculates a request.</p>
</div>
<div class="paragraph">
<p>The RequestPolicy interface have the following method defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface RequestPolicy {

    /**
     * Method in charge of generating a digest
     * of all significant data in a request that is needed
     * to determine that the call is same that is invoiced
     *
     * @param request the cachable http servlet request to aggregate request data for.
     * @return a RequestData containing a secure cryptographic digest of all significant request data.
     *
     * @throws IllegalArgumentException if supplied request contained invalid data.
     * @throws IOException if i/o related problems occurred reading the request data.
     * @throws InternalErrorException if internal errors occurred reading the request data.
     */
    RequestData significantRequestDataDigest(CachableHttpServletRequest request) throws IllegalArgumentException, IOException, InternalErrorException;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A tip is to aggregate all data required in a <em>ByteArrayOutputStream</em> and the create the cryptographic hash value
with the <em>DigestUtils.sha256(baos.toByteArray())</em> help method.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="orderrequestgeneratorparameter">3.2.4. The Order Request Generator Parameter</h4>
<div class="paragraph">
<p>By default is an OrderRequest generated to the PaymentHandler containing and article id, number of units, the
payPerRequest flag and the list of paymentOptions. But it is possible the create a custom OrderRequestGenerator
for specific purposes.</p>
</div>
<div class="paragraph">
<p>One use-case for creating a custom order request generator would be if the article Id or payment options should
be decided dynamically depending on data in the http request, such as body json data, instead of static data from
the @PaymentRequired annotation.</p>
</div>
<div class="sect4">
<h5 id="_creating_a_custom_order_request_generator">Creating a Custom Order Request Generator</h5>
<div class="paragraph">
<p>To create a custom order generator create a class implementing <em>org.lightningj.paywall.orderrequestgenerator.OrderRequestGenerator</em>
that contains one method that should generate a new OrderRequest object from the related PaymentRequired annotation
and HTTP Request object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface OrderRequestGenerator {

    /**
     * Method that should populate a new OrderRequest to initiate a
     * payment flow using the PaymentRequired annotation and the
     * related HTTP request.
     * @param paymentRequired the related annotation.
     * @param request the HTTP request related to the call.
     * @return a new OrderRequest.
     * @throws IllegalArgumentException if user supplied data was invalid to generate order request.
     * @throws InternalErrorException if problem occurred generated order request data due to internal miss configuration.
     */
    OrderRequest generate(PaymentRequired paymentRequired, CachableHttpServletRequest request) throws IllegalArgumentException, InternalErrorException;
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_payment_flows">3.3. Payment Flows</h3>
<div class="paragraph">
<p>The framework is designed to work in different system configurations. It not always desirable for
all micro services to have a direct connection with a lightning node but would like to centralise
this functionality to a central system handling the payment and the actual the paywalled service just
redirects the user to the central payment server until a settlement token have been issued and the requester
is redirected back to the original system.</p>
</div>
<div class="paragraph">
<p>Currently is only one payment flow supported, the <em>local payment flow</em>, but others will be added in the future.</p>
</div>
<div class="sect3">
<h4 id="_local_payment_flow">3.3.1. Local Payment Flow</h4>
<div class="paragraph">
<p>The default, and currently only payment flow available, is the <em>local payment flow</em>. It&#8217;s used when
the same system have all paywall components in same system (CheckSettlement controller, WebSocket Service,
LightningHandler etc) and have a direct connection with a lightning node.</p>
</div>
<div class="paragraph">
<p>Below is a flow chart describing all the steps in the local payment flow in detail. The blue boxes
indicate components that is a part of the target application, the rest is part of the Paywall framework.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/FlowDiagram-1-3-PaywallInterceptor.png" alt="FlowDiagram 1 3 PaywallInterceptor">
</div>
<div class="title">Figure 6. Flow Chart of Payment Interceptor using Local Payment Flow.</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">1.1 PaywallInterceptor intercept the request</dt>
<dd>
<p>This component is a part of the <em>paywall-spring</em> component and is
configured to parse all incoming request</p>
</dd>
<dt class="hdlist1">1.2 RestController in target application</dt>
<dd>
<p>The PaywallInterceptor lookup if target controller contains a
@PaymentRequired annotation. If that is the case and no valid settlement token exists in the HTTP header is a new
Payment Flow initiated.</p>
</dd>
<dt class="hdlist1">1.3 RequestPolicy Bean generates significant data</dt>
<dd>
<p>The request policy type is fetched up from the @PaymentRequired
annotation. And then is the significant data from the request calculated.</p>
</dd>
<dt class="hdlist1">1.4 OrderRequestGenerator generates a OrderRequest</dt>
<dd>
<p>The order request generator is fetched from
the @PaymentRequired annotation. And a order request, usually article id and units, is created.</p>
</dd>
<dt class="hdlist1">1.5 TokenGenerator generates PreImageData</dt>
<dd>
<p>The token generator bean generates a random preImage and preImageHash that
is used to uniquely identify the payment flow and use in the lightning invoice.</p>
</dd>
<dt class="hdlist1">1.6 PaymentHandler is called to generate an Order</dt>
<dd>
<p>The payment handler is called to create a new PaymentData which is
used to create and keep track of an invoice. This is done by calling the method
 <em>PaymentData newPaymentData(byte[] preImageHash, OrderRequest orderRequest)</em> that needs to be implemented by the target
application.</p>
</dd>
<dt class="hdlist1">1.7 CurrencyConverter converts amount to used crypto currency</dt>
<dd>
<p>The defined CurrencyConverter is called to optionally
convert the amount in the Order to the crypto amount used by the LightningHandler. By default is no conversion
performed and the payment handler is required to create orders with amount in CryptoAmount (i.e BTC).</p>
</dd>
<dt class="hdlist1">1.8 LightningHandler is called to create a lightning invoice</dt>
<dd>
<p>The configured LightningHandler is called
to create an invoice for the related payment. The LightningHandler also subscribes to settlement and updates the
PaymentHandler asynchronously using an event bus.</p>
</dd>
<dt class="hdlist1">1.9 TokenGenerator generates Invoice JWT Token</dt>
<dd>
<p>The token generator generates a signed and encrypted JWT (Java Web Token)
of type <em>invoice</em> used to certify the requester as <em>owner</em> of this payment flow and used when checking settlement.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Finally will the PaywallInterceptor generate a <a href="#invoicejson">Invoice JSON Data structure</a> and return it with HTTP
status code 402.</p>
</div>
<div class="paragraph">
<p>The next step in the flow is for the requester to check settlement. This can be done in two way either
by polling a Check Settlement REST API, or by subscribing to a pushed settlement messsage
over a WebSocket (used the the Javascript library by default). The flow diagram describes the inner workings of
the Check Settlement Controller.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images/FlowDiagram-2-CheckSettlement.png" alt="FlowDiagram 2 CheckSettlement">
</div>
<div class="title">Figure 7. Flow Chart of Check Settlement Controller Logic in Local Payment Flow.</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">2.1 Check Settlement Controller</dt>
<dd>
<p>A HTTP GET Request to check payment status. The controller
fetches for Invoice HTTP parameter <em>pwir</em> from the request URL.</p>
</dd>
<dt class="hdlist1">2.2 TokenGenerator parses the Invoice Token</dt>
<dd>
<p>Token Generator parses and validates the JWT and extracts
the preImageHash.</p>
</dd>
<dt class="hdlist1">2.3 The PaymentHandler is used to lookup the related PaymentData</dt>
<dd>
<p>The PaymentHandler&#8217;s
<em>PaymentData findPaymentData(byte[] preImageHash)</em> is called (that needs to be implemented by the target application)
to look up settlement status.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If the related PaymentData is marked as settled is 2.4 called otherwise is an empty
<a href="#settlementjson">Settlement JSON Data Structure</a> returned with only the field <em>settled</em> set to <em>false</em>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">2.4 Token Generator generates a Settlement Token</dt>
<dd>
<p>TokenGenerator generates an encrypted
and signed JWT of type <em>settlement</em>. Finally is a populated  <a href="#settlementjson">Settlement JSON Data Structure</a>
returned with all fields set.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The third step in the payment flow is for the request to call the target API again, this time with
the settlement token set as HTTP Header with name <em>Payment</em>. This step is displayed in the first flow chart.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">3.1 The PaywallInterceptor inspects the request again</dt>
<dd>
<p>This time it determines that settlement token
exists and starts with verification of payment.</p>
</dd>
<dt class="hdlist1">3.2 TokenGenerator parses the Settlement Token</dt>
<dd>
<p>The settlement token is parsed and validated.
It also checks if related payment is payPerRequest and if that is the case is step 3.3 called.</p>
</dd>
<dt class="hdlist1">3.3 PaymentHandler checks if request already have been executed</dt>
<dd>
<p>The PaymentHandler is called using the
<em>PaymentData findPaymentData(byte[] preImageHash)</em> method to verify that the request haven&#8217;t already been processed.</p>
</dd>
<dt class="hdlist1">3.4 RequestPolicy Bean generates significant data of new request</dt>
<dd>
<p>The significant data is calculated again.</p>
</dd>
<dt class="hdlist1">3.5 PaywallInterceptor calls paywalled controller</dt>
<dd>
<p>If significant data matches with data in settlement token will the
PaywallInterceptor let the request go through to the underlying controller.</p>
</dd>
<dt class="hdlist1">3.6 After the Target API have processed the request</dt>
<dd>
<p>If the payment flow is of type <em>payPerRequest</em> is PaymentHandler&#8217;s
method <em>void updatePaymentData(PaymentEventType type, PaymentData paymentData, LightningHandlerContext context)</em>
called with PaymentEventType set to <em>PaymentEventType.REQUEST_EXECUTED</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Finally it the response generated by the target API returned to the requester.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_customizing_paywall_components">3.4. Customizing Paywall Components</h3>
<div class="paragraph">
<p>Most of the components used in the Paywall framework can be customized by implementing the related interface
or overriding existing classes. This section details how to customize some of them.</p>
</div>
<div class="sect3">
<h4 id="_custom_currencyconverter">3.4.1. Custom CurrencyConverter</h4>
<div class="paragraph">
<p>A CurrencyConverter is in charge of converting the Amount specified in an Order created by the PaymentHandler
into the Amount that should be used in the Lightning invoice. One use-case is if the PaymentHandler returns the amount
in FIAT USD and the LightningHandler requires BTC. Then a CurrencyConverter is needed to convert the amount.</p>
</div>
<div class="paragraph">
<p>By default is <em>SameCryptoCurrencyConverter</em> used which doesn&#8217;t do any conversion. It is assumed the PaymentHandler will
return the Amount in the cryptocurrency used by the LightningHandler (i.e. BTC).</p>
</div>
<div class="paragraph">
<p>To customize, implement the interface <em>org.lightningj.paywall.currencyconverter.CurrencyConverter</em> that has one method
<em>CryptoAmount convert(Amount amount)</em> that needs to be implemented. See
<a href="javadoc/org/lightningj/paywall/currencyconverter/CurrencyConverter.html">JavaDoc</a> for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_lightninghandler">3.4.2. Custom LightningHandler</h4>
<div class="paragraph">
<p>A LightningHandler is in charge of connecting to a lightning node and create and subscribe to invoices. There exists
one LND implementation in paywall-core (actually two classes Base and Simple) and one extension in paywall-spring adding
Spring related functionality.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 8. Table Available PaymentRequired Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">LND Implementation Class</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">JavaDoc Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BaseLNDLightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Base implementation of LND Lightning Handler handling the methods for generateInvoice, lookupInvoice and invoice
subscribing. See SimpleBaseLNDLightningHandler that manages APIs, opening/closing connection. Extends this if custom
management of LND APIs should be done, otherwise use SimpleBaseLNDLightningHandler.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="javadoc/org/lightningj/paywall/lightninghandler/lnd/BaseLNDLightningHandler.html">JavaDoc</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SimpleBaseLNDLightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Extension of BaseLNDLightningHandler that also manages APIs and opening/closing connection. Implementing classes only
need to give host,port, path to TLS cert and macaroon.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="javadoc/org/lightningj/paywall/lightninghandler/lnd/SimpleBaseLNDLightningHandler.html">JavaDoc</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SpringLNDLightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Spring implementation of LND Lightning Handler.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="javadoc/org/lightningj/paywall/lightninghandler/lnd/SpringLNDLightningHandler.html">JavaDoc</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To implement a custom LightningHandler implement the interface <em>org.lightningj.paywall.lightninghandler.LightningHandler</em>. See
<a href="javadoc/org/lightningj/paywall/lightninghandler/LightningHandler.html">JavaDoc</a> for details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_keymanager">3.4.3. Custom KeyManager</h4>
<div class="paragraph">
<p>A KeyManager is in-charge of maintaining cryptographic keys with in the system. There exists two types of
key managers, SymmetricKeyManager managing symmetric keys
(<a href="javadoc/org/lightningj/paywall/keymgmt/SymmetricKeyManager.html">JavaDoc</a>), and AsymmetricKeyManager
(<a href="javadoc/org/lightningj/paywall/keymgmt/AsymmetricKeyManager.html">JavaDoc</a>) managing asymmetric keys.</p>
</div>
<div class="paragraph">
<p>Asymmetric keys is used in payment flows requiring multiple systems where trust needs to be set up between them.</p>
</div>
<div class="paragraph">
<p>The default implementation is DefaultFileKeyManager that implements both SymmetricKeyManager and AsymmetricKeyManager and
stores the keys on local disk, encrypted by a passphrase and generates the needed keys automatically when needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_tokengenerator">3.4.4. Custom TokenGenerator</h4>
<div class="paragraph">
<p>The TokenGenerator is responsible for generating signed and encrypted JWT Tokens and PreImageData. There exists two
implementations of TokenGenerator, SymmetricKeyTokenGenerator using symmetric key manager and used in the local payment
flow, and AsymmetricKeyTokenGenerator using asymmetric keys for payment flows requiring setting up trust between
different systems.</p>
</div>
<div class="paragraph">
<p>There are three type of JST tokens defined in table below. The local payment flow only uses
the Invoice and Settlement tokens.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 9. Table Available PaymentRequired Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">JWT Token Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Contains Data</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Payment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used in distributed payment flows where JWT token contains Order information to create a PaymentData.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OrderRequest, Order, RequestData</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains information about a lightning invoice, used when checking for settlement to prove ownership of the
payment flow.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OrderRequest, MinimalInvoice, RequestData</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settlement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains information that an invoice have been settled, including how for how long the settlement
is valid.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OrderRequest, Settlement, RequestData</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To create a customized TokenGenerator implement the interface <em>org.lightningj.paywall.tokengenerator.TokenGenerator</em>
See <a href="javadoc/org/lightningj/paywall/tokengenerator/TokenGenerator.html">JavaDoc</a> for details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spring_and_springboot_api">4. Spring and SpringBoot API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Currently is the LightningJ Paywall target to SpringBoot applications but other Java platforms might be implemented
in the future. This chapter describes all Spring specific parts of the framework in detail.</p>
</div>
<div class="paragraph">
<p>The framework is not specifically target for SpringBoot, all components in written for the more general Spring
version 5.1.4 and up. But test have mainly be done with Spring Boot 2.1.3.</p>
</div>
<div class="paragraph">
<p>The following Spring modules are required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>spring-context</p>
</li>
<li>
<p>spring-core</p>
</li>
<li>
<p>spring-web</p>
</li>
<li>
<p>spring-webmvc</p>
</li>
<li>
<p>spring-websocket</p>
</li>
<li>
<p>spring-messaging</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_available_profiles">4.1. Available Profiles</h3>
<div class="paragraph">
<p>The Paywall Spring module is configured using profiles and currently only one profile exists,
<em>paywall_local</em>, that enables all the local payment flow&#8217;s default beans.</p>
</div>
<div class="sect3">
<h4 id="_local_payment_flow_profile">4.1.1. Local Payment Flow Profile</h4>
<div class="paragraph">
<p>The local payment flow is a basic setup where the same node hosts all the required functionality
to service payment flows. I.e the node have access to a Lightning Node and hosts services for
for QR Code and Check Settlement. It also uses symmetric keys to sign and encrypt JWT tokens since
there are no requirements for intra-system trust.</p>
</div>
<div class="paragraph">
<p>To activate the local payment flow add the value <em>paywall_local</em> to the setting <em>spring.profiles.active</em>
in <em>application.properties</em>. See below for an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.profiles.active=paywall_local</pre>
</div>
</div>
<div class="paragraph">
<p>The profile registers the following beans by default using class
<em>org.lightningj.paywall.spring.local.LocalProfileBeanConfiguration</em>:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 10. Table Registered Beans for <em>paywall_local</em> profile.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Bean</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Registered Implementation</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">currencyConverter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.currencyconverter.CurrencyConverter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.currencyconverter.SameCryptoCurrencyConverter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implementation that expects payment handler to generate a CryptoAmount and does no convertion.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywallExceptionHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.spring.PaywallExceptionHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.spring.SpringPaywallExceptionHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bean that converts exceptions to returned error message data. This implementation converts exception
according to <a href="#exceptiontostatusmapping">Server Side Exception to HTTP Status Code</a>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.lightninghandler.LightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.spring.SpringLNDLightningHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A LND implementation requiring direct access to a LND node to create invoices and subscribe to
  settlements.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.keymgmt.KeyManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.spring.SpringDefaultFileKeyManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Keymanager that generates symmetric key and stores them on the local file system encrypted with a passphrase.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">qrCodeGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.qrcode.QRCodeGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.qrcode.DefaultQRCodeGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default implementation of QRCodeGenerator that generates PNG images of specified size.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tokenGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.tokengenerator.TokenGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.tokengenerator.SymmetricKeyTokenGenerator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWT Token Generator using symmetric key to sign and encrypt the token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">orderRequestGeneratorFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.orderrequestgenerator.OrderRequestGeneratorFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.orderrequestgenerator.OrderRequestGeneratorFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This class should generally not be overloaded, instead use customized OrderRequestGenerator
  configured in the @PaymentRequired annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">requestPolicyFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.requestpolicy.RequestPolicyFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.requestpolicy.RequestPolicyFactory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This class should generally not be overloaded, instead use customized RequestPolicy
  configured in the @PaymentRequired annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paymentFlowManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.paymentflow.PaymentFlowManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.spring.local.SpringLocalPaymentFlowManager</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Local payment flow manager that expects all functionality to be in the same system.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">webSocketSettledPaymentHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.spring.websocket.WebSocketSettledPaymentHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">org.lightningj.paywall.spring.websocket.WebSocketSettledPaymentHandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A WebSocket specific implementation when listing of settled payment handler.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_customizing_bean_configuration">4.1.2. Customizing Bean Configuration</h4>
<div class="paragraph">
<p>It is possible to customize beans that is registered for a given profile. In order to do this
add the setting <em>paywall.custombeans.enable</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.profiles.active=&lt;your_profile&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Then create a custom <em>Configuration</em> implementation that extends the default one. Below is an example configuration
overriding the default CurrencyConverter with a custom implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class CustomLocalProfileBeanConfiguration extends LocalProfileBeanConfiguration {

    @Bean({"currencyConverter"})
    @Override
    public CurrencyConverter getCurrencyConverter() {
        return new CustomCurrencyConverter();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_paywall_interceptor_filter">4.2. The Paywall Interceptor (Filter)</h3>
<div class="paragraph">
<p>The main component in the Paywall Spring framework is the Paywall Interceptor which filter all requests
and checks if target controller is annotated with @RESTController and @PaymentRequired and in that case
starts a payment flow if a settlement JWT token isn&#8217;t included in the header with name <em>Payment</em>.</p>
</div>
<div class="paragraph">
<p>If the filter determines that payment is required it initiates a payment flow according to the configured profile
and returns status code 401 (PAYMENT_REQUIRED) with a newly generated Invoice according to schema specified in
section <a href="#invoicejson">Invoice JSON Data</a>.</p>
</div>
<div class="paragraph">
<p>Currently are only @RestController annotated services supported but other types of controllers will be supported
in the future.</p>
</div>
<div class="sect3">
<h4 id="_interceptor_error_handling">4.2.1. Interceptor Error Handling</h4>
<div class="paragraph">
<p>If payment related error occurred in the Paywall Interceptor is an error message returned with JSON (or XML)
according to <a href="#paywallerrorjson">Paywall Error JSON Data</a> and http status code is mapped to the generated exception
according to table <a href="#exceptiontostatusmapping">Server Side Exception to HTTP Status Code</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_paywall_data_as_xml_response_instead_of_json">4.2.2. Paywall Data as XML Response instead of JSON</h4>
<div class="paragraph">
<p>The response is by default a JSON response with content type <em>application/json</em> but if header
<em>Accept</em> is set to <em>application/xml</em> or appending <em>.xml</em> to URL a XML variant of all paywall related responses will be
returned. The XML will be structured according to the following <a href="paywallspring_v1.xsd">XSD schema</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_available_spring_configuration_properties">4.3. Available Spring Configuration Properties</h3>
<div class="paragraph">
<p>Paywall-Spring contains a configuration bean PaywallProperties that contains different
settings available to the applicaton&#8217;s <em>application.properties</em> file.</p>
</div>
<div class="paragraph">
<p>Minimal configuration is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.profiles.active=paywall_local

paywall.lnd.hostname=somehost.org
paywall.lnd.port=10009
paywall.lnd.tlscertpath=/home/lnd/.lnd/tls.cert
paywall.lnd.macaroonpath=/home/lnd/.lnd/data/chain/bitcoin/testnet/invoice.macaroon
paywall.lnd.connectstring=8371729292821728191012918129172271827281262611282@10.10.10.1:9735

paywall.keys.keystorepath=~/ta-demo-keys
paywall.keys.password=foobar123</pre>
</div>
</div>
<div class="paragraph">
<p><em>Important</em>: If invoice.macaroon is used it is also required to set the setting <em>paywall.lnd.connectstring</em>
since the macaroon doesn&#8217;t have access rights to read node information automatically.</p>
</div>
<table id="paywallproperties" class="tableblock frame-all grid-all spread">
<caption class="title">Table 11. Table Available Paywall Spring Configuration Properties.</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LND and Lightning Properties:</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settings related to connecting to used LND Node.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lnd.hostname</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hostname of IP address of the LND node to connect to. Required if running local payment flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lnd.port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The port number of the LND node to connect to. Required if running local payment flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lnd.tlscertpath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the LND tls certificate to trust, securing the communication to the LND node.
  Should point to an file readable by the current user. Required if running local payment flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lnd.macaroonpath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path to the macaroon file that is used to authenticate to the LND node. The macaroon
  should have invoice creation rights. Required if running local payment flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lnd.connectstring</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The connect string displayed in node info part of generated invoices. It only needed to set this property if
  "paywall.lnd.connectstring" is set to true and macaroon used to connect to LND doesn&#8217;t have access rights to retrieve
  information. The connect string can be fetched using 'lncli getinfo' command.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lnd.network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNKNOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The network the LND node is connected to. (Optional) If LND macaroon used have access right
to fetch information, this can be done automatically. Default UNKNOWN. The current network can be fetched using
'lncli getinfo' command. Valid values are MAIN_NET, TEST_NET and UNKNOWN.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lnd.currency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BTC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The currency code the connected LND Node used. Should be one of CryptoAmount constants 'BTC' or 'LTC'.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.lightninghandler.autoconnect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if BasePaymentHandler should connect automatically to Lightning Node upon initialization of bean.
  if set to false should the implementing application connect the lightning handler manually during startup.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Management Settings:</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settings used for managing cryptographic keys for signing and encrypting the JWT Token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.keys.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path of directory where key files are stored. Recommended to set in a production environment. If not
set is a temporary directory used. Keys are created automatically in the directory if not exist.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.keys.keystorepath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The configured pass phrase used to protect generated keys. Recommended to set a good password in a production
  environment. If not set is no password protection used to encrypt the keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.keys.truststorepath</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The path of directory where trusted public key files are stored. For future use in a distributed setup.
  When using local payment flow symmetric keys are used and this settings is not needed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java Web Token (JWT) Settings:</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settings used to configure the generation of JWT Tokens.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.jwt.notbefore</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time in seconds for the not before field in generated
  JWT tokens. This can be positive if it should be valid in the future, or negative
  to support skewed clocked between systems. If unset is no not before date
  set in the generated JWT tokens. (Optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated Invoice and Settlement Settings:</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settings used to configure the generation of Invoices and Settings.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.invoice.defaultvalidity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3600 (1 hour)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default validity in seconds for generated invoices if no expire date have
  been set explicit in PaymentData.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.invoice.includenodeinfo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If node connection information should be included in generated invoices.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.invoice.registernew</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If settled invoice are received before any order have been created it should
  registered as new payments automatically before marking them as settled. For future use
  in a distributed setup. Not used in local payment flow mode.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.settlement.defaultvalidity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">24 * 60 * 60 (24 hours)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default validity for generated settlements if no valid until date have
  been set explicit in PaymentData.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">QR Code Generation End-Point Settings:</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settings used to configure the QR Code Image Generation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.qrcode.width.default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default QR Code width if no width parameter is specified in QR Code generation request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.qrcode.height.default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default QR Code height if no height parameter is specified in QR Code generation request.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.qrcode.url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/paywall/genqrcode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL to controller that generates QR code images.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Check Settlement End-Point Settings:</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settings used to configure the Check Settlement End Point.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.settlement.url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/paywall/api/checkSettlement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URL to the check settlement controller.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settlement WebSocket End-Point Settings:</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settings used to configure the Settlement WebSocket End Point.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.websocket.enable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">if WebSocket functionality should be enabled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paywall.websocket.settlement.url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/paywall/api/websocket/checksettlement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL of the end point where check settlement Web Socket is listening.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_available_supporting_services_end_points">4.4. Available Supporting Services End-Points</h3>
<div class="paragraph">
<p>The Spring Component in LightningJ Paywall provides a set of supporting end-points
for handling payment flows. One is for generating QR Codes, and one REST interface for
checking settlements using polling and one WebSocket end-point to set up a channel to
receive settlement as fast as possible.</p>
</div>
<div class="sect3">
<h4 id="_qr_code_generator_end_point">4.4.1. QR Code Generator End-Point</h4>
<div class="paragraph">
<p>Running in local payment flow mode there is a QR Code generation service used to
generate QR images for invoices. By default it is located at path '/paywall/genqrcode'
but can be modified to a custom location with setting <em>paywall.qrcode.url</em> in
<em>application.properties</em>.</p>
</div>
<div class="paragraph">
<p>The service is quite simple supports the following parameters and the GET HTTP Method:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 12. Table Available Query Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The data used to generate QR code for, I.e. bolt11 invoice. This parameter
  is set automatically in the qrLink field in the invoice json structure.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">w</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The width of the generated image. If not set is default width set by
  <em>paywall.qrcode.width.default</em> in <em>application.properties</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The height of the generated image. If not set is default height set by
  <em>paywall.qrcode.height.default</em> in <em>application.properties</em>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The service will return image data with content type <em>image/png</em> and content length set.
The constructed URL can be used directly as <em>src</em> attribute in an image html tag.</p>
</div>
</div>
<div class="sect3">
<h4 id="_check_settlement_end_point">4.4.2. Check Settlement End-Point</h4>
<div class="paragraph">
<p>In local payment flow mode there is a REST Service automatically created that can be used
to check if a given invoice have been settled.</p>
</div>
<div class="paragraph">
<p>To call the service to a GET HTTP request to <em>/paywall/api/checkSettlement</em> (the end-point path is
configurable with setting <em>paywall.settlement.url</em> in <em>application.properties</em>) with the
query parameter 'pwir' set to a URL encoded invoice JWT token.</p>
</div>
<div class="paragraph">
<p>The field <em>checkSettlementLink</em> in Invoice JSON Object contains the URL pre-populated with the
parameter set.</p>
</div>
<div class="paragraph">
<p>The service supports handling XML responses in the same way as the PaywallInterceptor and using the
same XSD schema. Just as PaywallInterceptor the service sets the HTTP header value: <em>PAYWALL_MESSAGE:TRUE</em>
to indicate this is a Paywall Related message.</p>
</div>
<div class="paragraph">
<p>For an unsettled payment will the following response be sent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "OK",
    "type": "settlement",
    "preImageHash": null,
    "token": null,
    "settlementValidUntil": null,
    "settlementValidFrom": null,
    "payPerRequest": null,
    "settled": false
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A settled payment will return the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
    "status": "OK",
    "type": "settlement",
    "preImageHash": "CP6p6AqgD7yL7QinVZDfkptiatr1ZkWN2MWVQ2WuSMg3",
    "token": "eyJhbGciOiJkaXIiLCJlbmMiOiJBMTI4Q0JDLUhTMjU2In0..c2g7sb8Rqz-fsoItbrnJ3g.l_c4MzlyTItGp_hbl2tyTSHXBq_8-P0Eds1d09CKiEV-RjqLyD0msk3-gn_DLpz-v-Eke2EHZa4J0vWVwzcxM06eu8tgBX4jIg7SIMD4Lr79PB4v6vPwyf3MnZsnBYGTUNP86CAjVRa-0mF1SuTBtjU05YsPGqEmqiPThpXyG3lRxarQzGJEMA4jUaivTdGGChBFWRJsEsZHOs1fm2EJZ3YNtL55V91GFAyE-diGj_tvhHqFIbjl_VvDJza96B0NZrxDFQbUrXWU9WFubSJq4zV9m7mHiJ5wTr-Jf7nSpUIUFXb-oH9OYjQF0Dk9zPCSz6r3JGk9vnUmhyR5WvAl9Rw3qm-rYg-BOVD9tEKl2K-U6ZKuLK2Q-EDta6hVDHHnl39iCIQMzFdB3cVMSHId0yZw1Va_5metok4TqRKFUvLsTNR93oeesew2NxqfKETUBoA4AoLs2THkEKFLXtPjYyD2rf7V7TCZkudUlZ0aSa8JCZZUaJSW4kTCNmZLo5zVtdrwsaGeJcdaAOtce-s0oT0rpTymCYU3KSl9_EgXiPvjS0sLrTfR7WaxHQJyfcRV.36IeZ1Nl8yiGD-Q2USzbog",
    "settlementValidUntil": "2019-06-02T07:10:29.354+0000",
    "settlementValidFrom": null,
    "payPerRequest": false,
    "settled": true
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details see the <a href="#settlementjson">Settlement JSON Data</a> description.</p>
</div>
</div>
<div class="sect3">
<h4 id="_check_settlement_websocket_end_point">4.4.3. Check Settlement WebSocket End-Point</h4>
<div class="paragraph">
<p>It is possible to subscribe to settlement tokens using a WebSocket connection. The websocket
is using Stomp protocol over SockJS in order to have a fallback to older browsers not supporting
WebSocket.</p>
</div>
<div class="paragraph">
<p>To subscribe to a payment flows settlement connect to the URL set in the <em>checkSettlementWebSocketEndpoint</em> field of the
invoice JSON and subscribe to the unique channel from the field <em>checkSettlementWebSocketQueue</em>.</p>
</div>
<div class="paragraph">
<p>Example code to connect to WebSocket using Javascript and set the required invoice JWT token in the
header, asserting ownership of the payment flow. (The example requires stomp.js and sockjs.js libraries, see
Javascript section for details):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">        function processWebSocketMessage(message){
            if(message.body){
                var settlement = JSON.parse(message.body);
                if(settlement.status === PaywallResponseStatus.OK){
                   // Process Settlement
                }else{
                    // error occurred
                }
            }else{
                console.debug("Paywall WebSocket, received empty message, ignoring.");
            }
        }

        function processWebSocketError(error){
            var errorObject;
            if(error.headers !== undefined){
                errorObject = {status: PaywallResponseStatus.SERVICE_UNAVAILABLE,
                    message: error.headers.message,
                    errors: [error.headers.message]
                };
            }else{
                errorObject = {status: PaywallResponseStatus.SERVICE_UNAVAILABLE,
                    message: error,
                    errors: [error  ]
                };
            }
        }

        var socket;
        var stompSocket;
        // Function that takes the invoice JSON Object and sets the invoice token in the
        // Stomp connect header
        function connect(invoice){
            socket = new SockJS(paywall.paywall.genCheckSettlementWebSocketLink());
            stompSocket = Stomp.over(socket);

            var headers = {"token": invoice.token};
            stompSocket.connect({}, function(frame) {
                stompSocket.subscribe(invoice.checkSettlementWebSocketQueue, processWebSocketMessage, headers);
            }, processWebSocketError);
        };

        function close(){
            if(stompSocket !== undefined){
                stompSocket.disconnect();
                socket.close();
            }
        };</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to override the default endpoint location of <em>/paywall/api/websocket/checksettlement</em> with
the setting <em>paywall.websocket.settlement.url</em> in application properties. It is also possible to
disable the web socket functionality with <em>paywall.websocket.enable</em> (enabled by default).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="javascriptapi">5. Javascript API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The paywall project has a Javascript library, made to simply preforming AJAX request to
a paywalled service.</p>
</div>
<div class="paragraph">
<p>The library&#8217;s main class is PaywallHttpRequest which wraps the standard XMLHttpRequest with
paywall functionality by triggering events such as when invoice was received and when it was
settled. The PaywallHttpRequest automatically calls the underlying service again after settlement.</p>
</div>
<div class="paragraph">
<p>The library also contains help methods for retrieving remaining time on invoice or settlement
before it expires and which units to display invoice amount in.</p>
</div>
<div class="sect2">
<h3 id="_prerequisites_2">5.1. Prerequisites</h3>
<div class="paragraph">
<p>In order to use the Javascript API you need to import the script paywall.js
into your web page. paywall.js has two dependency libraries, sockjs.js and stomp.js
used to open up web sockets.</p>
</div>
<div class="paragraph">
<p>Add the following to your web page, given that you placed the java script files in 'js' sub directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-html hljs" data-lang="html">    &lt;script src="js/sockjs.js"&gt;&lt;/script&gt;
    &lt;script src="js/stomp.js"&gt;&lt;/script&gt;
    &lt;script src="js/paywall.js"&gt;&lt;/script&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The required javascript files can be downloaded here:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Debug Version</th>
<th class="tableblock halign-left valign-top">Minified Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="dist/stomp.js">stomp.js</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="dist/stomp.min.js">stomp.min.js</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="dist/sockjs.js">sockjs.js</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="dist/sockjs.min.js">sockjs.min.js</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="dist/paywall.js">paywall.js</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="dist/paywall.min.js">paywall.min.js</a></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_the_paywallhttprequest_class">5.2. The PaywallHttpRequest Class</h3>
<div class="paragraph">
<p>To create a request to a paywalled server is very similar to a regular XMLHttpRequest but
using the PaywallHttpRequest class instead.</p>
</div>
<div class="paragraph">
<p>In more details the PaywallHttpRequest works in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It wraps one XMLHttpRequest instance and opens a connection to the service.</p>
</li>
<li>
<p>As soon as the header have been downloaded, it is inspected
for 402 (Payment Required).</p>
</li>
<li>
<p>If found is payment flow started, invoice is downloaded and a WebSocket channel
is opened to the server.</p>
</li>
<li>
<p>As soon as a settlement is sent through the WebSocket, a new XMLHttpRequest is created towards the service,
with all original request parameters set once more and the settlements JWT token in the request header</p>
</li>
<li>
<p>The new call should be accepted by the service and an onload event is triggered when download is complete.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The PaywallHttpRequest can also be used towards non-paywalled services and will then
function as a regular XMLHttpRequest with the exception that onloadstart event is never triggered.</p>
</div>
<div class="sect3">
<h4 id="_example_usages">5.2.1. Example Usages</h4>
<div class="paragraph">
<p>Plain Javascript is used in the examples but it should relative easy to adopt the code
to the Javascript framework of choice.</p>
</div>
<div class="sect4">
<h5 id="_a_simple_paywall_call">A Simple Paywall Call</h5>
<div class="paragraph">
<p>Below is a simple example of calling a paywalled service. In addition to a normal
XMLHttpRequest there are two event listeners created. One when invoice have been created
and should be displayed to the end user. And one when payment have been settled and invoice panel
should be removed from the web page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// Create a PaywallHttpRequest instance
var paywallHttpRequest = new PaywallHttpRequest();

// First set up event listeners

paywallHttpRequest.paywall.addEventListener("InvoiceListener", PaywallEventType.INVOICE, function (type, invoice) {
  // Add a Paywall Invoice event Listener that displays the invoice for the user.
  showInvoicePanel(invoice);
});

paywallHttpRequest.paywall.addEventListener("SettledListener", PaywallEventType.SETTLED, function (type, settlement) {
  // Hide the invoice panel as soon as the invoice have been payed.
  hideInvoicePanel();
});

paywallHttpRequest.onload = function(){
  // Process the service response as would be done with a regular XMLHttpRequest
  processServiceResponse(paywallHttpRequest.responseText);
}

// Open up a connection to the paywalled service.
paywallHttpRequest.open("POST","/someRestService");
// Send the data to the service that will trigger the payment flow if required.
paywallHttpRequest.send("{'data':'value'}");</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_displaying_invoice">Displaying Invoice</h5>
<div class="paragraph">
<p>The example below show Javascript to populate a panel in pure Javascript. This
could be done in a much more elegant way in a modern framework such as Angular or React.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function showInvoicePanel(invoice){
  // The invoice contains a number of fields that might be displayable.
  document.getElementById("invoicetext").innerText = invoice.description;
  document.getElementById('invoicebolt11').innerText = invoice.bolt11Invoice;

  // To display a QR Code, There is a QR generator link inside the paywallHttpRequest object
  // constructing a full URL to the QR Generation endpoint.
  // Just have a img tag and set the src attribute to:
  var invoiceQRImg = document.getElementById('invoiceqr');
  invoiceQRImg.src = paywallHttpRequest.paywall.genQRLink();

  // Amount field have a special help function to display amount in a specified unit.
  // In this example we display the amount in BIT.
  document.getElementById('invoiceamount').innerText = paywallHttpRequest.paywall.getInvoiceAmount().as(BTCUnit.BIT);

  // If node info exists on server it is also possible to display connection
  // information
  document.getElementById('invoiceNodeInfo').innerText = invoice.nodeInfo.connectString;

 }</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_displaying_remaining_times">5.2.2. Displaying Remaining Times</h4>
<div class="paragraph">
<p>There also exists help methods to display a count down counter of remaining validity of
invoice and settlement as well as a count down until a settlement is valid if settlment validity is set in future.</p>
</div>
<div class="paragraph">
<p>The methods are paywallHttpRequest.paywall.getInvoiceExpiration(), paywallHttpRequest.paywall.getSettlementExpiration()
and paywallHttpRequest.paywall.getSettlementValidFrom(). The method returns a PaywallTime object that have
help methods to retrieve the number of hours, minutes and seconds left in order to create a hh:mm:ss counter. The
counter never gets to negative but stops as 00:00:00.</p>
</div>
<div class="paragraph">
<p>Example code to create a count down counter displaying mm:ss left on an invoice validity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">function updateInvoiceRemainingTime(){
  var remainingTime = paywallHttpRequest.paywall.getInvoiceExpiration().remaining();
  document.getElementById('invoiceTimeRemaining').innerText = timeRemaining.minutes() + ":" + timeRemaining.seconds();
}

setInterval(updateInvoiceRemainingTime, 1000);</code></pre>
</div>
</div>
<div class="paragraph">
<p>An alternative to create a remaining time object is to create a PaywallAmount object
manually with a given JSON CryptoAmount.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">var amountInSat = new PaywallAmount(invoice.invoiceAmount).as(BTCUnit.SAT);</code></pre>
</div>
</div>
<div class="paragraph">
<p>See classes PaywallTime and PaywallTimeUnit in Javascript API documentation for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_displaying_amount_with_a_given_unit">5.2.3. Displaying Amount with a Given Unit</h4>
<div class="paragraph">
<p>The Invoice JSON always returns amount in a base unit (i.e satoshi) with a given magnetude of none, milli or nano.</p>
</div>
<div class="paragraph">
<p>To display amount in other units such as BTC, micro BTC or BIT etc. There exists a help method to convert invoice amount
into a specified unit. There are two ways of doing this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">// One way is to call paywallHttpRequest object
var amountInBit = paywallHttpRequest.paywall.getInvoiceAmount().as(BTCUnit.BIT);

// The other if you have access to invoice object is to create a PaywallAmount object and
// pass the invoice.invoiceAmount.
var amountInBit2 = new PaywallAmount(invoice.invoiceAmount).as(BTCUnit.BIT);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Available BTC Units are:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 13. Table Available BTCUnit Values</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Unit</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BTC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BTC, i.e 100.000.000 Satoshis.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MILLIBTC</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">One thousand part of BTC, i.e 100.000 Satoshis.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In BIT, i.e 100 Satoshis.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In Satoshis.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MILLISAT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In milli satoshis, 1/1000 satoshi.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NANOSAT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">In nano satoshis, 1/1000.000 satoshi.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_reusing_settlement_for_multiple_calls">5.2.4. Reusing Settlement for Multiple Calls</h4>
<div class="paragraph">
<p>If the payment flow is not per-request is is possible to reuse
the paywallHttpRequest as long as it has the state SETTLED. To do this
just perform a recall of first open() then send() methods. As long as the data
in open and send calls fulfils the defined request policy the calls will succeed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_calling_non_paywalled_services">5.2.5. Calling Non-Paywalled Services</h4>
<div class="paragraph">
<p>It is possible to use PaywallHttpRequest as a regular XMLHttpRequest to non-paywalled services
and it will work in the same way with the only difference that onloadstart event is not triggered.</p>
</div>
</div>
<div class="sect3">
<h4 id="_handling_links_from_the_invoice_json_object">5.2.6. Handling Links from the Invoice JSON Object</h4>
<div class="paragraph">
<p>The links in Invoice JSON can be both relative or full URLs depending on server side configuration.
There exists help methods in PaywallHttpRequest that always constructs the full URLs.</p>
</div>
<div class="paragraph">
<p>These help methods are: paywallHttpRequest.paywall.genQRLink(), paywallHttpRequest.paywall.genCheckSettlementLink(),
paywallHttpRequest.paywall.genCheckSettlementWebSocketLink().</p>
</div>
</div>
<div class="sect3">
<h4 id="_error_handling">5.2.7. Error Handling</h4>
<div class="paragraph">
<p>There are three types of error that can occur, either it is a XMLHttpRequest error, API error or Paywall related error.</p>
</div>
<div class="paragraph">
<p>To handle a XMLHttpRequest error (that is triggered when connection related issues occurs) is 'onerror' event handler called
in same way as XMLHttpRequest.</p>
</div>
<div class="paragraph">
<p>To handle API errors from the underlying service is done in the same way as would have been done in a regular
XMLHttpRequest after load is status code and response text examined for error message.</p>
</div>
<div class="paragraph">
<p>If paywall error occurs is a PAYWALL_ERROR event triggered and the payment flow state is set to PAYWALL_ERROR.
The error message can be retrieved with paywallHttpRequest.paywall.getPaywallError(). See table 'Paywall Error JSON Object Properties'
for details about the generated error messages.</p>
</div>
</div>
<div class="sect3">
<h4 id="_available_paywallhttprequest_states">5.2.8. Available PaywallHttpRequest States</h4>
<div class="paragraph">
<p>A PaywallHttpRequest has a state that can be fetched by the paywallHttpRequest.paywall.getState() that
returns one of the values of the PaywallState enumeration defined in table below.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 14. Table Available Paywall States</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">State</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NEW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Payment flow is new and no invoice have yet been generated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoice have been generated and is waiting to be settled.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE_EXPIRED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated invoice have expired and a new payment flow have to be generated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SETTLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Payment have been settled and the payment flow should be ready to perform the call.
  If multiple calls is possible is up to the settlement type.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXECUTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Payment type is of type pay per request and request have been processed successfully.
  Never set if related payment flow is not pay-per-request. Then it will be SETTLED until
  SETTLEMENT expires.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SETTLEMENT_NOT_YET_VALID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated settlement is not yet valid and need to wait until call can be performed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SETTLEMENT_EXPIRED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated settlement have expired and new payment flow have to be generated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PAYWALL_ERROR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paywall API related error occurred during processing of payment flow, see paywallError object for details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ABORTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request was aborted by the user by calling the abort() method.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_available_events_generated_by_paywallhttprequest">5.2.9. Available Events Generated by PaywallHttpRequest</h4>
<div class="sect4">
<h5 id="_wrapped_xmlhttprequest_events">Wrapped XMLHttpRequest Events</h5>
<div class="paragraph">
<p>During POST of data the following upload events are also triggered, see XMLHttpRequest standard for details.</p>
</div>
<div class="paragraph">
<p>One exception is when calling unpaywalled services with PaywallHttpRequest, in that case is
'onloadstart' event never triggered since it was captured when parsing headers for '402 Payment Required' header.</p>
</div>
</div>
<div class="sect4">
<h5 id="_paywall_specific_events">Paywall Specific Events</h5>
<div class="paragraph">
<p>There are a number of paywall related events extending the regular XMLHttpRequest
events in order to handle displaying of invoice and hiding invoice upon settlement.</p>
</div>
<div class="paragraph">
<p>To register a listener use the method paywallHttpRequest.paywall.addEventListener(name, type, callback), where
the name parameter should be a unique name for the listener within the PaywallHttpRequest object, type is
one of defined event types in table below, with the special type 'ALL' matching all paywall
related events.</p>
</div>
<div class="paragraph">
<p>To remove a listener from a PaywallHttpRequest use paywallHttpRequest.paywall.removeEventListener(name)</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 15. Table Paywall Specific Event Types</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Event Type</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Object Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoice have been generated and is waiting to be settled. Time remaining of invoice can
  be fetched with the paywallHttpRequest.paywall.getInvoiceExpiration() method.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoice JSON Object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INVOICE_EXPIRED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated invoice have expired and a new payment flow have to be generated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Invoice JSON Object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SETTLED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Payment have been settled and the payment flow should be ready to perform the call.
  If multiple calls is possible is up to the settlement type.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settlement JSON Object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EXECUTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Payment type is of type pay per request and request have been processed successfully.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settlement JSON Object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SETTLEMENT_NOT_YET_VALID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated settlement is not yet valid and need to wait until call can be performed.
  Time remaining until settlement is valid can be fetched with the paywallHttpRequest.paywall.getSettlementValidFrom()
  method.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settlement JSON Object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SETTLEMENT_EXPIRED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generated settlement have expired and new payment flow have to be generated.
  Time remaining until settlement is expired can be fetched with the paywallHttpRequest.paywall.getSettlementExpiration()
  method.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Settlement JSON Object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">PAYWALL_ERROR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paywall API related error occurred during processing of payment flow, see paywallError object for details.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Paywall Error Object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Special value used when registering new listener that should receive notification for all events
  related to this paywall flow.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_defined_json_data_structures">5.3. Defined JSON Data structures</h3>
<div class="paragraph">
<p>This section defines all JSON Data Structures used in the underlying API. When using the PaywallHttpRequest the
structures are usually sent when event is triggered.</p>
</div>
<div class="paragraph">
<p>All structures can also be retrieved as XML by setting the 'Accept' header to content type 'application/xml' or
appending '.xml' to the request service url.</p>
</div>
<div class="sect3">
<h4 id="_invoice_json_object">5.3.1. Invoice JSON Object</h4>
<div class="paragraph">
<p>An invoice JSON Object is returned whenever a service with @PaymentRequired annotation determines that a new
payment flow is required. The service will the return HTTP Status PAYMENT_REQUIRED (402) and
the Invoice Json Object as data.</p>
</div>
<table id="invoicejson" class="tableblock frame-all grid-all spread">
<caption class="title">Table 16. Table Invoice JSON Object Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The status of the response, should always be 'OK'. Used to indicate if this JSON Object is not an error message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of JSON Object, always the value 'invoice'.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preImageHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The generated preImageHash from PreImageData which acts as an unique id for the payment flow. The string
  is base58 encoded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bolt11Invoice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The bolt11 invoice to display for the requester.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description to display in the invoice. (Optional).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceAmount</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Amount Json Object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The amount in the invoice. (Optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodeInfo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node Info Json Object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Information about the related lightning node. (Optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The generated JWT invoice token used to track the payment when checking settlement. This is sent
  in the header of websocket connections or calls the checkSettlement service.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time this invoice was created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">invoiceExpireDate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time the invoice will expire.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payPerRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If payment is for this api is for one time only or usage is for a given period of time.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">requestPolicyType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifying type of policy used for aggregating significant request data. See section defining RequestPolicyType values
  in @PaymentRequired annotation for description.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkSettlementLink</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link to settlement controller for checking payment state. Used if it&#8217;s not possible to use WebSockets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">qrLink</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link to QR Code generator service. This is the full link that can be set in src attribute if &lt;img&gt; tags in order to
  display the QR Code.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkSettlementWebSocketEndpoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL to the WebSocket CheckSettlement EndPoint. This connection is done automatically by PaywallHttpRequest.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkSettlementWebSocketQueue</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The preImageHash unique (payment flow) web socket queue to subscribe to.</p></td>
</tr>
</tbody>
</table>
<div class="sect4">
<h5 id="_crypto_amount_json_object">Crypto Amount JSON Object</h5>
<div class="paragraph">
<p>Crypt Amount JSON is a sub object inside the Invoice JSON Object and specifies the amount
to pay.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 17. Table Crypto Amount JSON Object Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The crypto amount value. For BTC it is based on satoshis with given magnetude.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">currencyCode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specification of type of crypto currency. Currently is only 'BTC' supported.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">magnetude</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The magnetude of specified base unit, either 'NONE', 'MILLI' or 'NANO'. If not specified
  is 'NONE' (full satoshis) assumed.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_node_info_json_object">Node Info JSON Object</h5>
<div class="paragraph">
<p>Node Info is an optional sub object to Invoice JSON specifying how to connect to the service
lightning node. It is configured on server side if this should be populated or not.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 18. Table Node Info JSON Object Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">publicKeyInfo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The underlying lightning node&#8217;s public Key information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodeAddress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The underlying lightning the node&#8217;s address.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nodePort</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The underlying lightning the node&#8217;s port.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mainNet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the node is connected to testnet or real production network.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">connectString</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The complete connect string to the lightning node.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_settlement_json_object">5.3.2. Settlement JSON Object</h4>
<div class="paragraph">
<p>The settlement JSON Object is sent through the web socket as soon as settlement was
detected or as a response to the checkSettlement endpoint. I contains the JWT token that
can be used towards the paywalled API as a proof of payment.</p>
</div>
<table id="settlementjson" class="tableblock frame-all grid-all spread">
<caption class="title">Table 19. Table Node Info JSON Object Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The status of the response, should always be 'OK'. Used to indicate if this JSON Object is not an error message.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of JSON Object, always the value 'settlement'.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">preImageHash</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The generated preImageHash from PreImageData which acts as an unique id for the payment flow. The string
  is base58 encoded. (Optional, always set if settled)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The generated settlement JWT Token that should be set as header value in regular API call in order
  for the @PaymentRequired annotation to accept it. This is done automatically by PaywallHttpRequest class.
  (Optional, always set if settled)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementValidUntil</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The date and time the settlement is valid until. (Optional, always set if settled)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settlementValidFrom</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The date and time the settlement is valid from (Optional).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payPerRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If related payment is for one request only or if multiple requests can be done that fits the request policy.
  (Optional, always set if settled)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">settled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If related payment have been settled.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_paywall_error_json_object">5.3.3. Paywall Error JSON Object</h4>
<div class="paragraph">
<p>The paywall error JSON is created if error occurred in the paywall related components.
The error object if occurred can be fetched with paywallHttpRequest.paywall.getPaywallError().
Regular errors from the underlying API is handled in the same way as if XMLHttpRequest would be used.</p>
</div>
<table id="paywallerrorjson" class="tableblock frame-all grid-all spread">
<caption class="title">Table 20. Table Paywall Error JSON Object Properties</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the related the HTTP status code, for example 'UNAUTHORIZED'. The used HTTP status code to exception mapping is
  described in table below.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A descriptive error message associated with exception.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">errors</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of more detailed error messages of problems that occurred. (Optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">reason</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If error is related to JWT token, otherwise null. Available values are EXPIRED, NOT_YET_VALID, NOT_FOUND, INVALID. (Optional)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are a defined service side exception to http status mapping for all defined services such
as the payment required filter, QR code generator end point and checkSettlement end point.</p>
</div>
<table id="exceptiontostatusmapping" class="tableblock frame-all grid-all spread">
<caption class="title">Table 21. Table Map of Server Side Exception to HTTP Status Code.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Http Status Code</th>
<th class="tableblock halign-left valign-top">Mapped Exception</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BAD_REQUEST (400)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IllegalArgumentException</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNAUTHORIZED (401)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IllegalArgumentException</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SERVICE_UNAVAILABLE (504)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IOException</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTERNAL_SERVER_ERROR (500)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All other exceptions</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_doc">5.4. Javascript Doc</h3>
<div class="paragraph">
<p>Latest Javascript API documentation describing all API calls for the PaywallHttpRequest can be found <a href="jsdoc/index.html">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_for_paywall_developers">6. For Paywall Developers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LightningJ Paywall is a Java project built using Gradle. Tests is written
using Groovy and Spock Framework.</p>
</div>
<div class="sect2">
<h3 id="_building">6.1. Building</h3>
<div class="paragraph">
<p>To build the project use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew build</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_framework">6.2. Testing the framework</h3>
<div class="paragraph">
<p>The framework have multiple test suites:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java Unit tests using Spock</p>
</li>
<li>
<p>Javascript Unit tests using Jasmine</p>
</li>
<li>
<p>Java Integration tests connecting to LND node.</p>
</li>
<li>
<p>Java Functional tests that tests a Spring Boot application and Javascript library in Chrome
and Firefox.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_unit_tests">6.2.1. Unit Tests</h4>
<div class="paragraph">
<p>To run the unit tests run the command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew check</pre>
</div>
</div>
<div class="paragraph">
<p>This will run both Java and Javascript unit tests at once. To only run jasmine test it is possible
by issuing:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew grunt_jasmine</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_integration_tests">6.2.2. Integration Tests</h4>
<div class="paragraph">
<p>There exists a test suite that run LND connection specific tests. To run these you need access to a LND
node and configure the following properties in your ~/.gradle/gradle.properties.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>paywall.integration.test.lnd.host=&lt;SET THIS&gt;
paywall.integration.test.lnd.port=&lt;SET THIS&gt;
paywall.integration.test.lnd.tlscertpath=&lt;SET PATH&gt;/tls.cert
paywall.integration.test.lnd.macaroonpath=&lt;SET PATH&gt;/admin.macaroon</pre>
</div>
</div>
<div class="paragraph">
<p>Then run the tests with the command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew integrationTest</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functional_tests">6.2.3. Functional Tests</h4>
<div class="paragraph">
<p>The Javascript API and overall Spring Boot functionality it tested with functional tests. There exists
functional tests for Chrome and Firefox browser and requires that you have these browsers installed
in you development environment. Sometimes the version of the browser must match the version of the selenium version
in paywall-springboot2/build.gradle in order for the test to run properly.</p>
</div>
<div class="paragraph">
<p>To run the functional test suite run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew functionalTest</pre>
</div>
</div>
<div class="paragraph">
<p>To only run a specific browser it is possible to instead use the tasks <em>chromeTest</em> or <em>firefoxTest</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pre_release_tests">6.2.4. Pre-Release Tests</h4>
<div class="paragraph">
<p>Before release is should unit, integration and functional tests be verified with the command.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew preReleaseTest</pre>
</div>
</div>
<div class="paragraph">
<p>This requires that integration and functional test suites are set up.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_reports">6.2.5. Test Reports</h4>
<div class="paragraph">
<p>Latest Java test reports are located <a href="allTests/index.html">here</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generating_a_release">6.3. Generating a Release</h3>
<div class="sect3">
<h4 id="_gpg_sign_releases_using_smartcard">6.3.1. GPG Sign Releases using SmartCard</h4>
<div class="paragraph">
<p>To GPG Sign generated archives before publishing them to central repository using GPG Smartcard make
sure to configure the following in ~/.gradle/gradle.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre>signing.gnupg.executable=gpg2
signing.gnupg.useLegacyGpg=false
signing.gnupg.keyName=&lt;your key id&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uploading_archives_to_maven_central">6.3.2. Uploading Archives to Maven Central</h4>
<div class="paragraph">
<p>The signed releases should be uploaded to maven central. In order to do this there is needed an account
in oss.sonatype.org with access rights to manage lightningj projects.</p>
</div>
<div class="paragraph">
<p>Before uploading set the following to settings in ~/.gradle/gradle.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ossrhUsername=
ossrhPassword=</pre>
</div>
</div>
<div class="paragraph">
<p>Then to build, sign and upload archives to Maven Central run the command
(first make sure to update the version):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew uploadArchives</pre>
</div>
</div>
<div class="paragraph">
<p>The release is placed in <em>Staging Repositories</em> section. Select latest open and press close
Enter a comment and wait for verification to complete (Press Refresh). Then press Release to release
the version. The release will be at Maven Central within a couple of hours.</p>
</div>
</div>
<div class="sect3">
<h4 id="_updating_the_website">6.3.3. Updating the Website</h4>
<div class="paragraph">
<p>To generate documentation use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew build preReleaseTest doc</pre>
</div>
</div>
<div class="paragraph">
<p>The generated documentation will be placed in <em>build/docs/html5</em>. After verifying it is correct
it is possible to publish the web site to github using the command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew gitPublishPush</pre>
</div>
</div>
<div class="paragraph">
<p>Enter your Github credentials in the GUI and the website will be updated.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_release_draft_in_github">6.3.4. Creating a Release Draft in GitHub</h4>
<div class="paragraph">
<p>To upload javascript to github and draft a new release use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./gradlew build githubRelease</pre>
</div>
</div>
<div class="paragraph">
<p>Before creating a draft set a personal access token from Github and add it to settings in ~/.gradle/gradle.properties</p>
</div>
<div class="literalblock">
<div class="content">
<pre>paywallGithubReleaseToken=</pre>
</div>
</div>
<div class="paragraph">
<p>Personal access tokens can be generated under developer settings in your github account, the token
should have write access to the paywall repository.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-08-03 08:49:34 CEST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>